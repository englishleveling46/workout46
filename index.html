<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/backendless@7.4.6/dist/backendless.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for Lucide icons to ensure they are rendered */
        [data-lucide] {
            display: inline-block;
        }
        /* Style for the live clock to ensure proper alignment if needed */
        #current-date {
            line-height: 1.4; /* Adjust line height for two lines of text */
        }
        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1a1a1a;
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px; /* Adjusted for potentially wider content */
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white font-inter">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4" style="display: none;">
        <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-6 border border-white/10 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                Fitness Tracker
            </h2>
            <div class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="auth-email" placeholder="email@example.com" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-300 mb-1">M·∫≠t kh·∫©u</label>
                    <input type="password" id="auth-password" placeholder="M·∫≠t kh·∫©u" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                </div>
                <button id="signup-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold">
                    ƒêƒÉng k√Ω
                </button>
                <button id="signin-btn" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold">
                    ƒêƒÉng nh·∫≠p
                </button>
            </div>
            <p class="text-center text-gray-400 text-xs mt-4">
                S·ª≠ d·ª•ng email v√† m·∫≠t kh·∫©u ƒë·ªÉ ƒëƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√Ω.
            </p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <div class="bg-black/20 backdrop-blur-lg border-b border-white/10 sticky top-0 z-50">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl">
                            <i data-lucide="flame" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                Fitness Tracker
                            </h1>
                            <p class="text-xs text-gray-400">Theo d√µi t·∫≠p luy·ªán h√†ng ng√†y</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="current-date" class="text-lg font-bold"></div>
                        <div class="text-xs text-gray-400">Th·ªùi gian hi·ªán t·∫°i</div>
                    </div>
                </div>

                <div class="flex bg-gray-800/50 rounded-xl p-1">
                    <button id="today-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        H√¥m nay
                    </button>
                    <button id="my-workouts-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        B√†i t·∫≠p c·ªßa t√¥i
                    </button>
                    <button id="stats-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        Th·ªëng k√™
                    </button>
                </div>
            </div>
        </div>

        <div id="main-content" class="px-4 py-4 pb-20">
            </div>

        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
            <div class="text-center">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-purple-400 mb-4"></i>
                <p class="text-lg font-medium">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        </div>
    </div>

    <div id="message-area" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 p-3 rounded-lg text-white text-center shadow-lg transition-all duration-300 transform -translate-y-full opacity-0" style="min-width: 250px;"></div>

    <div id="workout-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-workout-name" class="text-xl font-bold text-white"></h3>
                <button id="close-workout-detail-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-workout-image-container" class="mb-4 text-center">
            </div>

            <div id="modal-sets-reps-editor" class="bg-gray-800/50 p-4 rounded-lg mb-4" style="display: none;">
                <h4 class="text-md font-semibold mb-3 text-center">Ch·ªânh s·ª≠a H√¥m nay</h4>
                <div class="flex items-start justify-around space-x-1 sm:space-x-2 mb-3">
                    <!-- Sets -->
                    <div class="flex flex-col items-center flex-1">
                        <label for="modal-sets-input" class="block text-xs sm:text-sm font-medium text-gray-300 mb-1">Sets</label>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <button id="sets-decrement-btn" class="bg-red-500/70 hover:bg-red-600 p-1.5 sm:p-2 rounded-md transition-colors">
                                <i data-lucide="minus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            </button>
                            <input type="number" id="modal-sets-input" class="w-10 sm:w-12 bg-gray-700 border border-gray-600 rounded-lg px-1 py-1 sm:py-1.5 text-white text-center placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <button id="sets-increment-btn" class="bg-green-500/70 hover:bg-green-600 p-1.5 sm:p-2 rounded-md transition-colors">
                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Reps -->
                    <div class="flex flex-col items-center flex-1">
                        <label for="modal-reps-input" class="block text-xs sm:text-sm font-medium text-gray-300 mb-1">Reps</label>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <button id="reps-decrement-btn" class="bg-red-500/70 hover:bg-red-600 p-1.5 sm:p-2 rounded-md transition-colors">
                                <i data-lucide="minus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            </button>
                            <input type="number" id="modal-reps-input" class="w-10 sm:w-12 bg-gray-700 border border-gray-600 rounded-lg px-1 py-1 sm:py-1.5 text-white text-center placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <button id="reps-increment-btn" class="bg-green-500/70 hover:bg-green-600 p-1.5 sm:p-2 rounded-md transition-colors">
                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Weight -->
                    <div class="flex flex-col items-center flex-1">
                        <label for="modal-weight-input" class="block text-xs sm:text-sm font-medium text-gray-300 mb-1">T·∫° (kg)</label>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                            <button id="weight-decrement-btn" class="bg-red-500/70 hover:bg-red-600 p-1.5 sm:p-2 rounded-md transition-colors">
                                <i data-lucide="minus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            </button>
                            <input type="number" id="modal-weight-input" class="w-10 sm:w-12 bg-gray-700 border border-gray-600 rounded-lg px-1 py-1 sm:py-1.5 text-white text-center placeholder-gray-400 focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                            <button id="weight-increment-btn" class="bg-green-500/70 hover:bg-green-600 p-1.5 sm:p-2 rounded-md transition-colors">
                                <i data-lucide="plus" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button id="save-workout-details-btn" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold mt-2">
                    L∆∞u thay ƒë·ªïi
                </button>
            </div>
            
            <div id="modal-workout-history-section" style="display: block;">
                <h4 class="text-lg font-semibold mb-2">L·ªãch s·ª≠ 5 ng√†y g·∫ßn nh·∫•t:</h4>
                <div id="modal-workout-history" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let workouts = []; // Daily workouts
        let allWorkouts = []; // Master list of workouts
        let streak = 0;
        let totalWorkouts = 0;
        let weeklyStats = [];
        let currentTab = 'today';
        let showAddWorkoutFormToday = false;
        let showAddWorkoutFormMyWorkouts = false;
        let isLoading = true; 

        let currentDayString = new Date().toISOString().split('T')[0];
        let streakLastAchievedDate = null;

        const MAX_WEEKLY_STATS_DAYS = 30;
        const MODAL_WEIGHT_ADJUST_STEP = 2.5;


        const BACKENDLESS_APP_ID = 'E1DD6501-EFB3-4E39-BED7-597DE3133D98';
        const BACKENDLESS_JS_API_KEY = '8983A173-7621-4F13-924C-3C17494E74EA';

        Backendless.initApp(BACKENDLESS_APP_ID, BACKENDLESS_JS_API_KEY);

        let userId = null; 

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = message;
            messageArea.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 p-3 rounded-lg text-white text-center shadow-lg transition-all duration-300 transform opacity-100 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            }`;
            messageArea.style.transform = 'translateY(0)';
            messageArea.style.opacity = '1';

            setTimeout(() => {
                messageArea.style.transform = 'translateY(-100%)';
                messageArea.style.opacity = '0';
            }, 3000); 
        }

        function updateLiveDateTime() {
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                const dateString = now.toLocaleDateString('vi-VN', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit'
                });
                currentDateElement.innerHTML = `<span class="text-base">${timeString}</span><br>${dateString}`;
            }
        }

        async function loadDataFromBackendless() {
            isLoading = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            if (document.querySelector('#loading-overlay [data-lucide="loader-2"]')) { 
                 lucide.createIcons();
            }

            if (!userId) {
                console.warn("User not authenticated. Cannot load data from Backendless.");
                isLoading = false;
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }

            try {
                const dailyWorkoutsQueryBuilder = Backendless.DataQueryBuilder.create()
                    .setWhereClause(`ownerId = '${userId}' AND workout_date = '${getTodayDateString()}'`);
                const dailyWorkoutsData = await Backendless.Data.of('DailyWorkouts').find(dailyWorkoutsQueryBuilder);
                workouts = dailyWorkoutsData || [];

                const allWorkoutsQueryBuilder = Backendless.DataQueryBuilder.create(); // Assuming AllWorkouts are not owner-specific or managed differently. If owner-specific: .setWhereClause(`ownerId = '${userId}'`)
                const allWorkoutsData = await Backendless.Data.of('AllWorkouts').find(allWorkoutsQueryBuilder);
                allWorkouts = allWorkoutsData || [];

                const userStatsQueryBuilder = Backendless.DataQueryBuilder.create()
                    .setWhereClause(`ownerId = '${userId}'`);
                const userStatsData = await Backendless.Data.of('UserStats').find(userStatsQueryBuilder);

                if (userStatsData && userStatsData.length > 0) {
                    const userStats = userStatsData[0];
                    streak = userStats.streak || 0;
                    totalWorkouts = userStats.total_workouts || 0;
                    weeklyStats = userStats.weekly_stats ? JSON.parse(userStats.weekly_stats) : [];
                    streakLastAchievedDate = userStats.streak_last_achieved_date;
                } else {
                    const newUserStats = { ownerId: userId, streak: 0, total_workouts: 0, weekly_stats: JSON.stringify([]) };
                    await Backendless.Data.of('UserStats').save(newUserStats);
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Backendless:", error);
                showMessage(`L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}.`, "error");
                workouts = []; allWorkouts = []; streak = 0; totalWorkouts = 0; weeklyStats = []; streakLastAchievedDate = null;
            } finally {
                isLoading = false;
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        async function saveDataToBackendless() { // This function specifically saves UserStats
            if (!userId) {
                showMessage("L·ªói: B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u d·ªØ li·ªáu.", "error");
                return;
            }
            const saveButton = document.getElementById('save-data-to-sheet-btn'); 
            const originalButtonHtml = saveButton ? saveButton.innerHTML : '';
            if (saveButton) {
                saveButton.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> <span class="hidden sm:inline">ƒêang l∆∞u...</span>';
                saveButton.disabled = true;
                lucide.createIcons();
            }

            try {
                const userStatsQueryBuilder = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}'`);
                const existingUserStats = await Backendless.Data.of('UserStats').find(userStatsQueryBuilder);
                let userStatsToSave = {
                    streak: streak, total_workouts: totalWorkouts,
                    weekly_stats: JSON.stringify(weeklyStats),
                    streak_last_achieved_date: streakLastAchievedDate
                };
                if (existingUserStats && existingUserStats.length > 0) {
                    userStatsToSave.objectId = existingUserStats[0].objectId;
                } else {
                    userStatsToSave.ownerId = userId;
                }
                await Backendless.Data.of('UserStats').save(userStatsToSave);
                if (saveButton) showMessage("D·ªØ li·ªáu th·ªëng k√™ ƒë√£ ƒë∆∞·ª£c l∆∞u!", "success");
            } catch (error) {
                console.error("L·ªói khi g·ª≠i UserStats ƒë·∫øn Backendless:", error);
                showMessage(`L·ªói khi l∆∞u d·ªØ li·ªáu th·ªëng k√™: ${error.message}.`, "error");
            } finally {
                if (saveButton) {
                    saveButton.innerHTML = originalButtonHtml || '<i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">L∆∞u d·ªØ li·ªáu</span>';
                    saveButton.disabled = false;
                    lucide.createIcons();
                }
            }
        }

        function initializeAppAndHandleDailyRollover() {
            const todayStr = getTodayDateString();
            if (currentDayString !== todayStr) {
                const pastDayActualCompletions = workouts.filter(w => w.completed).length;
                const pastDayTotalTasks = workouts.length;
                const lastDayStatIndex = weeklyStats.findIndex(s => s.date === currentDayString);

                if (lastDayStatIndex > -1 && new Date(currentDayString).toDateString() === new Date(new Date(todayStr).getTime() - 86400000).toDateString()) {
                    weeklyStats[lastDayStatIndex].total = pastDayTotalTasks;
                    weeklyStats[lastDayStatIndex].completed = pastDayActualCompletions;
                    weeklyStats[lastDayStatIndex].exercises = workouts.map(w => w.name);
                } else if (pastDayTotalTasks > 0 || pastDayActualCompletions > 0) {
                     weeklyStats.push({
                        date: currentDayString, total: pastDayTotalTasks,
                        completed: pastDayActualCompletions, exercises: workouts.map(w => w.name)
                    });
                }

                weeklyStats.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (weeklyStats.length > MAX_WEEKLY_STATS_DAYS) weeklyStats = weeklyStats.slice(0, MAX_WEEKLY_STATS_DAYS);

                if (pastDayTotalTasks > 0 && pastDayActualCompletions === pastDayTotalTasks) {
                    if (streakLastAchievedDate) {
                        const expectedPrevStreakDate = new Date(new Date(currentDayString).getTime() - 86400000).toISOString().split('T')[0];
                        if (streakLastAchievedDate === expectedPrevStreakDate) streak++; else streak = 1;
                    } else streak = 1;
                    streakLastAchievedDate = currentDayString;
                } else {
                    const yesterdayStr = new Date(new Date(todayStr).getTime() - 86400000).toISOString().split('T')[0];
                    if (currentDayString === yesterdayStr && pastDayTotalTasks > 0) { // Only reset streak if there were tasks yesterday and not all were completed
                        streak = 0; 
                        streakLastAchievedDate = null; 
                    }
                }
                workouts = []; 
                currentDayString = todayStr;
                // After rollover, load today's workouts if any were pre-scheduled or carried over (not typical for this app structure but good practice)
                // For this app, this means today's `workouts` array starts empty.
                // LoadDataFromBackendless will fetch today's workouts again IF the app logic includes pre-populating future dates.
                // In our case, it re-fetches today's empty list (or any workouts ALREADY for today in DB)
            }
            updateCurrentDayWeeklyStat(); // This will also save UserStats
        }

        function updateCurrentDayWeeklyStat() {
            if (!currentDayString) return;
            const todayActualCompletions = workouts.filter(w => w.completed).length;
            const todayTotalTasks = workouts.length;
            const todayStatPayload = {
                date: currentDayString, total: todayTotalTasks,
                completed: todayActualCompletions, exercises: workouts.map(w => w.name)
            };
            const existingStatIndex = weeklyStats.findIndex(s => s.date === currentDayString);
            if (existingStatIndex > -1) weeklyStats[existingStatIndex] = todayStatPayload;
            else weeklyStats.push(todayStatPayload);
            weeklyStats.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (weeklyStats.length > MAX_WEEKLY_STATS_DAYS) weeklyStats = weeklyStats.slice(0, MAX_WEEKLY_STATS_DAYS);
            saveDataToBackendless(); // Saves all UserStats including streak, totalWorkouts, weeklyStats
        }

        function getCompletedCount() { return workouts.filter(w => w.completed).length; }
        function getCompletionRate() { const c = getCompletedCount(); return workouts.length > 0 ? Math.round((c / workouts.length) * 100) : 0; }
        function formatDate(dateString) {
            const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() + userTimezoneOffset); // Adjust to local date part before formatting
            return localDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', weekday: 'short' });
        }
        function getWeeklyAverage() {
            if (weeklyStats.length === 0) return 0; const relevantStats = weeklyStats.slice(0, 7);
            const totalCompleted = relevantStats.reduce((sum, day) => sum + day.completed, 0);
            const totalPossible = relevantStats.reduce((sum, day) => sum + day.total, 0);
            return totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        }
        function getMostActiveDay() {
            if (weeklyStats.length === 0) return 'Ch∆∞a c√≥'; let maxCompleted = -1; let mostActiveDayData = null;
            for (const day of weeklyStats) { if (day.completed > maxCompleted) { maxCompleted = day.completed; mostActiveDayData = day; } }
            return mostActiveDayData && maxCompleted > 0 ? formatDate(mostActiveDayData.date) : 'Ch∆∞a c√≥';
        }
        function getCurrentWeekTotalCompleted() { const r = weeklyStats.slice(0, 7); return r.reduce((s, d) => s + d.completed, 0); }

        function renderHeader() {
            const todayTabBtn = document.getElementById('today-tab-btn');
            const myWorkoutsTabBtn = document.getElementById('my-workouts-tab-btn');
            const statsTabBtn = document.getElementById('stats-tab-btn');
            const baseClass = "flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all";
            const activeClass = "bg-gradient-to-r from-purple-500 to-pink-500 text-white";
            const inactiveClass = "text-gray-400 hover:text-white";
            todayTabBtn.className = `${baseClass} ${currentTab === 'today' ? activeClass : inactiveClass}`;
            myWorkoutsTabBtn.className = `${baseClass} ${currentTab === 'my-workouts' ? activeClass : inactiveClass}`;
            statsTabBtn.className = `${baseClass} ${currentTab === 'stats' ? activeClass : inactiveClass}`;
        }

        function renderTodayTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-green-500/20 to-green-600/20 backdrop-blur-lg rounded-xl p-3 border border-green-500/30 text-center">
                        <i data-lucide="check-circle-2" class="w-6 h-6 text-green-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${getCompletedCount()}</p><p class="text-xs text-green-300">Ho√†n th√†nh</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500/20 to-red-500/20 backdrop-blur-lg rounded-xl p-3 border border-orange-500/30 text-center">
                        <i data-lucide="flame" class="w-6 h-6 text-orange-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${streak}</p><p class="text-xs text-orange-300">Ng√†y li√™n ti·∫øp</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 backdrop-blur-lg rounded-xl p-3 border border-blue-500/30 text-center">
                        <i data-lucide="trophy" class="w-6 h-6 text-blue-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${getCompletionRate()}%</p><p class="text-xs text-blue-300">Ti·∫øn ƒë·ªô</p>
                    </div>
                </div>
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 mb-6 border border-white/10">
                    <div class="flex items-center justify-between mb-3"><h3 class="font-semibold">Ti·∫øn ƒë·ªô h√¥m nay</h3><span class="text-sm text-gray-400">${getCompletedCount()}/${workouts.length}</span></div>
                    <div class="w-full bg-gray-700 rounded-full h-3 mb-2"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: ${getCompletionRate()}%"></div></div>
                    <p class="text-xs text-gray-400 text-center">${getCompletionRate() === 100 && workouts.length > 0 ? 'üéâ Xu·∫•t s·∫Øc! Ho√†n th√†nh t·∫•t c·∫£ b√†i t·∫≠p!' : workouts.length > 0 ? `C√≤n ${workouts.length - getCompletedCount()} b√†i t·∫≠p n·ªØa` : 'Th√™m b√†i t·∫≠p cho h√¥m nay!'}</p>
                </div>
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden mb-6">
                    <div class="p-4 border-b border-white/10">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-bold">B√†i t·∫≠p h√¥m nay</h2>
                            <div class="flex space-x-2">
                                <button id="save-data-to-sheet-btn" class="flex items-center space-x-1 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                                    <i data-lucide="save" class="w-4 h-4"></i><span class="hidden sm:inline">L∆∞u d·ªØ li·ªáu</span>
                                </button>
                                <button id="add-workout-today-btn" class="flex items-center space-x-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                                    <i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Th√™m</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="add-new-workout-form-today" class="p-4 bg-gray-800/50 border-b border-white/10" style="display: ${showAddWorkoutFormToday ? 'block' : 'none'};">
                        <div class="flex justify-end mb-3"><button id="close-add-form-today-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input type="text" id="new-workout-name-today" placeholder="T√™n b√†i t·∫≠p" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                            <input type="number" id="new-workout-sets-today" placeholder="S·ªë Sets" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-reps-today" placeholder="S·ªë Reps" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-weight-today" placeholder="T·∫° (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                            <input type="text" id="new-workout-image-url-today" placeholder="URL h√¨nh ·∫£nh (t√πy ch·ªçn)" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                        </div>
                        <div class="flex space-x-3 mt-3"><button id="add-new-workout-today-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors text-sm">Th√™m v√†o h√¥m nay</button></div>
                    </div>
                    <div id="workout-list-container" class="p-4 space-y-3"></div>
                </div>`;
            document.getElementById('add-workout-today-btn').onclick = () => { showAddWorkoutFormToday = true; renderApp(); };
            document.getElementById('save-data-to-sheet-btn').onclick = saveDataToBackendless; // This saves UserStats
            if (showAddWorkoutFormToday) {
                document.getElementById('close-add-form-today-btn').onclick = () => { showAddWorkoutFormToday = false; renderApp(); };
                document.getElementById('add-new-workout-today-btn').onclick = addNewWorkoutFromTodayTab;
            }
            renderWorkoutItems();
            lucide.createIcons();
        }

        async function renderWorkoutItems() {
            const workoutListContainer = document.getElementById('workout-list-container');
            if (!workoutListContainer) return;
            workoutListContainer.innerHTML = workouts.length === 0 ? '<p class="text-center text-gray-400 py-4">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</p>' : '';

            for (const workout of workouts) {
                const workoutItem = document.createElement('div');
                workoutItem.className = `group flex items-center justify-between p-3 rounded-xl border transition-all duration-200 ${workout.completed ? 'bg-green-500/10 border-green-500/30' : 'bg-gray-800/50 border-gray-700'}`;
                const currentVolume = (workout.num_sets || 0) * (workout.num_reps || 0); // Calculate volume here
                const comparisonResult = await getPreviousWorkoutPerformance(workout.master_id, currentVolume);
                let comparisonIcon = '', comparisonColor = 'text-gray-400';
                if (comparisonResult === 'increased') { comparisonIcon = '<i data-lucide="arrow-up" class="w-4 h-4 text-green-400"></i>'; comparisonColor = 'text-green-400'; }
                else if (comparisonResult === 'decreased') { comparisonIcon = '<i data-lucide="arrow-down" class="w-4 h-4 text-red-400"></i>'; comparisonColor = 'text-red-400'; }
                else if (comparisonResult === 'same') { comparisonIcon = '<i data-lucide="minus" class="w-4 h-4 text-blue-400"></i>'; comparisonColor = 'text-blue-400'; }
                else { comparisonIcon = '<i data-lucide="info" class="w-4 h-4 text-gray-400"></i>'; }

                workoutItem.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1">
                        <button class="toggle-workout-btn transition-colors hover:scale-110 transform flex-shrink-0" data-id="${workout.objectId}">
                            ${workout.completed ? '<i data-lucide="check-circle-2" class="w-5 h-5 text-green-400"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-gray-400 hover:text-green-400"></i>'}
                        </button>
                        <div class="flex items-center space-x-3 flex-1 cursor-pointer workout-details-trigger" data-master-id="${workout.master_id}" data-workout-name="${workout.name}" data-image-url="${workout.image_url || ''}" data-object-id="${workout.objectId}">
                            ${workout.image_url ? `<img src="${workout.image_url}" alt="${workout.name}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/48x48/6b7280/ffffff?text=NoImg';"/>` : `<div class="w-12 h-12 flex items-center justify-center bg-gray-700 rounded-lg flex-shrink-0"><i data-lucide="image" class="w-6 h-6 text-gray-400"></i></div>`}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2">
                                    <h3 class="font-medium text-sm ${workout.completed ? 'text-green-400 line-through' : 'text-white'} truncate">${workout.name}</h3>
                                    <span class="text-xs ${comparisonColor}">${comparisonIcon}</span>
                                </div>
                                <p class="text-gray-400 text-xs mt-1">${workout.num_sets} sets x ${workout.num_reps} reps @ ${workout.weight_kg != null ? workout.weight_kg : '0'}kg</p>
                            </div>
                        </div>
                    </div>
                    <button class="remove-workout-btn opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-all duration-200 ml-2 flex-shrink-0" data-id="${workout.objectId}"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                workoutListContainer.appendChild(workoutItem);
            }
            document.querySelectorAll('.toggle-workout-btn').forEach(b => { b.onclick = (e) => toggleWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('.remove-workout-btn').forEach(b => { b.onclick = (e) => removeWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('#workout-list-container .workout-details-trigger').forEach(el => {
                el.onclick = (e) => showWorkoutDetails(e.currentTarget.dataset.masterId, e.currentTarget.dataset.workoutName, e.currentTarget.dataset.imageUrl, e.currentTarget.dataset.objectId);
            });
            lucide.createIcons();
        }

        async function getPreviousWorkoutPerformance(masterId, currentVolume) {
            const qb = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}' AND master_id = '${masterId}' AND workout_date < '${getTodayDateString()}'`).setSortBy(['workout_date DESC']).setPageSize(1);
            const data = await Backendless.Data.of('DailyWorkouts').find(qb);
            if (data && data.length > 0) {
                const prevVol = (data[0].num_sets || 0) * (data[0].num_reps || 0); // Ensure volume is calculated correctly
                if (currentVolume > prevVol) return 'increased'; if (currentVolume < prevVol) return 'decreased'; return 'same';
            } return 'no_data';
        }
        
        function rebindListeners(elementId, newOnClick) {
            const originalElement = document.getElementById(elementId);
            if (!originalElement) return null;
            const newElement = originalElement.cloneNode(true);
            originalElement.parentNode.replaceChild(newElement, originalElement);
            if (newOnClick) {
                newElement.onclick = newOnClick;
            }
            return newElement; 
        }

        async function showWorkoutDetails(masterId, workoutName, imageUrl, currentWorkoutObjectId = null) {
            const modal = document.getElementById('workout-detail-modal');
            const modalWorkoutName = document.getElementById('modal-workout-name');
            const modalWorkoutImageContainer = document.getElementById('modal-workout-image-container');
            
            const modalSetsRepsEditor = document.getElementById('modal-sets-reps-editor');
            const modalSetsInput = document.getElementById('modal-sets-input');
            const modalRepsInput = document.getElementById('modal-reps-input');
            const modalWeightInput = document.getElementById('modal-weight-input');

            const modalWorkoutHistorySection = document.getElementById('modal-workout-history-section');
            const modalWorkoutHistory = document.getElementById('modal-workout-history');

            modalWorkoutName.textContent = workoutName;
            if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined' || imageUrl.trim() === '') {
                modalWorkoutImageContainer.innerHTML = `<div class="w-full h-48 flex items-center justify-center bg-gray-700 rounded-lg"><i data-lucide="image" class="w-24 h-24 text-gray-400"></i></div>`;
            } else {
                modalWorkoutImageContainer.innerHTML = `<img src="${imageUrl}" alt="Workout Image" class="w-full h-48 object-contain rounded-lg" onerror="this.onerror=null;this.parentElement.innerHTML = '<div class=\\'w-full h-48 flex items-center justify-center bg-gray-700 rounded-lg\\'><i data-lucide=\\'image-off\\' class=\\'w-24 h-24 text-gray-400\\'></i></div>'; lucide.createIcons();" />`;
            }
            
            if (currentWorkoutObjectId) { // Popup from "Today" tab
                modalSetsRepsEditor.style.display = 'block';
                if (modalWorkoutHistorySection) modalWorkoutHistorySection.style.display = 'none';

                const currentWorkout = workouts.find(w => w.objectId === currentWorkoutObjectId);
                if (currentWorkout) {
                    modalSetsInput.value = currentWorkout.num_sets;
                    modalRepsInput.value = currentWorkout.num_reps;
                    modalWeightInput.value = currentWorkout.weight_kg != null ? currentWorkout.weight_kg : 0;
                } else {
                    modalSetsInput.value = 1; modalRepsInput.value = 1; modalWeightInput.value = 0;
                    console.warn(`Workout with objectId ${currentWorkoutObjectId} not found for modal editor.`);
                }

                rebindListeners('sets-decrement-btn', () => {
                    const cv = parseInt(modalSetsInput.value); modalSetsInput.value = Math.max(1, (isNaN(cv) ? 2 : cv) - 1);
                });
                rebindListeners('sets-increment-btn', () => {
                    const cv = parseInt(modalSetsInput.value); modalSetsInput.value = (isNaN(cv) ? 0 : cv) + 1;
                });
                rebindListeners('reps-decrement-btn', () => {
                    const cv = parseInt(modalRepsInput.value); modalRepsInput.value = Math.max(1, (isNaN(cv) ? 2 : cv) - 1);
                });
                rebindListeners('reps-increment-btn', () => {
                    const cv = parseInt(modalRepsInput.value); modalRepsInput.value = (isNaN(cv) ? 0 : cv) + 1;
                });
                rebindListeners('weight-decrement-btn', () => {
                    const cv = parseFloat(modalWeightInput.value); modalWeightInput.value = (Math.max(0, (isNaN(cv) ? MODAL_WEIGHT_ADJUST_STEP : cv) - MODAL_WEIGHT_ADJUST_STEP)).toFixed(2);
                });
                rebindListeners('weight-increment-btn', () => {
                    const cv = parseFloat(modalWeightInput.value); modalWeightInput.value = ((isNaN(cv) ? -MODAL_WEIGHT_ADJUST_STEP : cv) + MODAL_WEIGHT_ADJUST_STEP).toFixed(2);
                });
                rebindListeners('save-workout-details-btn', () => {
                    const newSets = parseInt(modalSetsInput.value); 
                    const newReps = parseInt(modalRepsInput.value);
                    const newWeight = parseFloat(modalWeightInput.value);

                    if (!isNaN(newSets) && !isNaN(newReps) && !isNaN(newWeight) && newSets > 0 && newReps > 0 && newWeight >= 0) {
                        updateWorkoutDetails(currentWorkoutObjectId, newSets, newReps, newWeight);
                    } else { showMessage("Sets, Reps ph·∫£i l√† s·ªë d∆∞∆°ng v√† T·∫° ph·∫£i l√† s·ªë kh√¥ng √¢m!", "error"); }
                });

            } else { // Popup from "My Workouts" tab
                modalSetsRepsEditor.style.display = 'none';
                if (modalWorkoutHistorySection) modalWorkoutHistorySection.style.display = 'block';

                const queryBuilder = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}' AND master_id = '${masterId}'`).setSortBy(['workout_date DESC']).setPageSize(5);
                try {
                    const historyData = await Backendless.Data.of('DailyWorkouts').find(queryBuilder);
                    modalWorkoutHistory.innerHTML = ''; 
                    if (historyData && historyData.length > 0) {
                        historyData.forEach(entry => { 
                            const item = document.createElement('div'); item.className = 'flex justify-between items-center bg-gray-800/50 p-3 rounded-lg';
                            item.innerHTML = `<span class="text-sm font-medium">${formatDate(entry.workout_date)}</span><span class="text-sm text-gray-300">${entry.num_sets}x${entry.num_reps} @ ${entry.weight_kg != null ? entry.weight_kg : '0'}kg</span>`;
                            modalWorkoutHistory.appendChild(item);
                        });
                    } else { modalWorkoutHistory.innerHTML = '<p class="text-center text-gray-400">Ch∆∞a c√≥ l·ªãch s·ª≠.</p>'; }
                } catch (error) {
                    console.error("L·ªói t·∫£i l·ªãch s·ª≠ b√†i t·∫≠p:", error);
                    modalWorkoutHistory.innerHTML = '<p class="text-center text-red-400">L·ªói t·∫£i l·ªãch s·ª≠.</p>';
                }
            }
            modal.classList.add('open');
            lucide.createIcons();
        }

        function closeWorkoutDetailsModal() { document.getElementById('workout-detail-modal').classList.remove('open'); }

        async function updateWorkoutDetails(objectId, newSets, newReps, newWeight) {
            const workoutIndex = workouts.findIndex(w => w.objectId === objectId);
            if (workoutIndex > -1) {
                const updatedWorkout = { 
                    objectId: objectId, 
                    num_sets: newSets, 
                    num_reps: newReps, 
                    weight_kg: newWeight,
                    volume: newSets * newReps // Volume still sets * reps for comparison consistency
                };
                try {
                    await Backendless.Data.of('DailyWorkouts').save(updatedWorkout);
                    workouts[workoutIndex].num_sets = newSets; 
                    workouts[workoutIndex].num_reps = newReps; 
                    workouts[workoutIndex].weight_kg = newWeight;
                    workouts[workoutIndex].volume = newSets * newReps;
                    updateCurrentDayWeeklyStat(); 
                    showMessage("ƒê√£ c·∫≠p nh·∫≠t chi ti·∫øt b√†i t·∫≠p!", "success");
                    closeWorkoutDetailsModal(); 
                    renderApp();
                } catch (error) { console.error("L·ªói c·∫≠p nh·∫≠t chi ti·∫øt b√†i t·∫≠p:", error); showMessage("L·ªói c·∫≠p nh·∫≠t chi ti·∫øt b√†i t·∫≠p.", "error"); }
            }
        }

        function renderMyWorkoutsTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden mb-6">
                    <div class="p-4 border-b border-white/10"><div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold">T·∫•t c·∫£ b√†i t·∫≠p c·ªßa t√¥i</h2>
                        <button id="add-workout-my-workouts-btn" class="flex items-center space-x-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Th√™m b√†i t·∫≠p m·ªõi</span>
                        </button></div></div>
                    <div id="add-new-workout-form-my-workouts" class="p-4 bg-gray-800/50 border-b border-white/10" style="display: ${showAddWorkoutFormMyWorkouts ? 'block' : 'none'};">
                        <div class="flex justify-end mb-3"><button id="close-add-form-my-workouts-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input type="text" id="new-workout-name-my-workouts" placeholder="T√™n b√†i t·∫≠p" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                            <input type="number" id="new-workout-sets-my-workouts" placeholder="S·ªë Sets" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-reps-my-workouts" placeholder="S·ªë Reps" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-default-weight-my-workouts" placeholder="T·∫° m·∫∑c ƒë·ªãnh (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                            <input type="text" id="new-workout-image-url-my-workouts" placeholder="URL h√¨nh ·∫£nh (t√πy ch·ªçn)" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                        </div>
                        <div class="flex space-x-3 mt-3"><button id="add-new-workout-my-workouts-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors text-sm">Th√™m v√†o danh s√°ch ch√≠nh</button></div>
                    </div>
                    <div id="all-workouts-list-container" class="p-4 space-y-3"></div>
                </div>`;
            document.getElementById('add-workout-my-workouts-btn').onclick = () => { showAddWorkoutFormMyWorkouts = true; renderApp(); };
            if (showAddWorkoutFormMyWorkouts) {
                document.getElementById('close-add-form-my-workouts-btn').onclick = () => { showAddWorkoutFormMyWorkouts = false; renderApp(); };
                document.getElementById('add-new-workout-my-workouts-btn').onclick = addNewWorkoutFromMyWorkoutsTab;
            }
            renderAllWorkoutItems();
            lucide.createIcons();
        }

        function renderAllWorkoutItems() {
            const cont = document.getElementById('all-workouts-list-container'); if (!cont) return;
            cont.innerHTML = allWorkouts.length === 0 ? '<p class="text-center text-gray-400 py-4">Ch∆∞a c√≥ b√†i t·∫≠p n√†o.</p>' : '';
            allWorkouts.sort((a,b) => (a.name || "").localeCompare(b.name || "")).forEach(w => { // Sort alphabetically
                const item = document.createElement('div'); item.className = `flex items-center justify-between p-3 rounded-xl border bg-gray-800/50 border-gray-700`;
                item.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1 cursor-pointer workout-details-trigger" data-master-id="${w.objectId}" data-workout-name="${w.name}" data-image-url="${w.image_url || ''}">
                        ${w.image_url ? `<img src="${w.image_url}" alt="${w.name}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/48x48/6b7280/ffffff?text=NoImg';"/>` : `<div class="w-12 h-12 flex items-center justify-center bg-gray-700 rounded-lg flex-shrink-0"><i data-lucide="image" class="w-6 h-6 text-gray-400"></i></div>`}
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm text-white truncate">${w.name}</h3>
                            <p class="text-gray-400 text-xs mt-1">${w.num_sets}x${w.num_reps} @ ${w.default_weight_kg != null ? w.default_weight_kg : '0'}kg (m·∫∑c ƒë·ªãnh)</p>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-2 flex-shrink-0">
                        <button class="add-to-today-btn bg-green-500 hover:bg-green-600 p-2 rounded-lg text-xs transition-colors" data-id="${w.objectId}"><i data-lucide="calendar-plus" class="w-4 h-4"></i></button>
                        <button class="remove-master-workout-btn text-red-400 hover:text-red-300 transition-all duration-200" data-id="${w.objectId}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                cont.appendChild(item);
            });
            document.querySelectorAll('.add-to-today-btn').forEach(b => { b.onclick = (e) => addSelectedWorkoutToToday(e.currentTarget.dataset.id); });
            document.querySelectorAll('.remove-master-workout-btn').forEach(b => { b.onclick = (e) => removeMasterWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('#all-workouts-list-container .workout-details-trigger').forEach(el => {
                el.onclick = (e) => showWorkoutDetails(e.currentTarget.dataset.masterId, e.currentTarget.dataset.workoutName, e.currentTarget.dataset.imageUrl, null);
            });
            lucide.createIcons();
        }

        function renderStatsTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-lg rounded-xl p-4 border border-purple-500/30 text-center">
                            <i data-lucide="activity" class="w-8 h-8 text-purple-400 mx-auto mb-2"></i><p class="text-2xl font-bold">${getCurrentWeekTotalCompleted()}</p><p class="text-xs text-purple-300">B√†i t·∫≠p (7 ng√†y)</p></div>
                        <div class="bg-gradient-to-br from-green-500/20 to-blue-500/20 backdrop-blur-lg rounded-xl p-4 border border-green-500/30 text-center">
                            <i data-lucide="award" class="w-8 h-8 text-green-400 mx-auto mb-2"></i><p class="text-2xl font-bold">${getWeeklyAverage()}%</p><p class="text-xs text-green-300">TB ho√†n th√†nh (7 ng√†y)</p></div>
                    </div>
                    <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 border border-white/10">
                        <h3 class="text-lg font-bold mb-4 flex items-center"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-purple-400"></i>L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h3>
                        <div id="weekly-stats-container" class="space-y-3"></div></div>
                    <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 border border-white/10">
                        <h3 class="text-lg font-bold mb-4 flex items-center"><i data-lucide="trophy" class="w-5 h-5 mr-2 text-yellow-400"></i>Th√†nh t√≠ch</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-orange-500/20 rounded-lg"><i data-lucide="flame" class="w-5 h-5 text-orange-400"></i></div><div><p class="font-medium">Chu·ªói ng√†y li√™n ti·∫øp</p><p class="text-sm text-gray-400">T·∫≠p luy·ªán ƒë·ªÅu ƒë·∫∑n</p></div></div><span class="text-xl font-bold text-orange-400">${streak} ng√†y</span></div>
                            <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-green-500/20 rounded-lg"><i data-lucide="calendar" class="w-5 h-5 text-green-400"></i></div><div><p class="font-medium">Ng√†y t√≠ch c·ª±c nh·∫•t</p><p class="text-sm text-gray-400">Ho√†n th√†nh nhi·ªÅu nh·∫•t</p></div></div><span class="text-sm font-bold text-green-400">${getMostActiveDay()}</span></div>
                            <div class="flex items-center justify-between p-3 bg-blue-500/20 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-blue-500/20 rounded-lg"><i data-lucide="trending-up" class="w-5 h-5 text-blue-400"></i></div><div><p class="font-medium">T·ªïng b√†i t·∫≠p</p><p class="text-sm text-gray-400">T·ª´ khi b·∫Øt ƒë·∫ßu</p></div></div><span class="text-xl font-bold text-blue-400">${totalWorkouts}</span></div>
                        </div></div></div>`;
            renderWeeklyStatsHistory();
            lucide.createIcons();
        }

        function renderWeeklyStatsHistory() {
            const cont = document.getElementById('weekly-stats-container'); if (!cont) return;
            cont.innerHTML = weeklyStats.length === 0 ? '<p class="text-center text-gray-400 py-4">Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™.</p>' : '';
            weeklyStats.forEach(day => {
                const perc = day.total > 0 ? (day.completed / day.total) * 100 : 0;
                const isToday = day.date === getTodayDateString();
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg ${isToday && day.date === currentDayString ? 'bg-purple-500/20 border border-purple-500/30' : 'bg-gray-800/50'}`;
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2"><span class="text-sm font-medium">${formatDate(day.date)}${isToday && day.date === currentDayString ? '<span class="text-purple-400 ml-1">(H√¥m nay)</span>' : ''}</span></div>
                        <span class="text-sm text-gray-400">${day.completed}/${day.total}</span></div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-1"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${perc}%"></div></div>
                    ${day.exercises && day.exercises.length > 0 ? `<div class="flex flex-wrap gap-1 mt-2">${day.exercises.slice(0,3).map(ex => `<span class="px-2 py-0.5 bg-gray-700/80 rounded text-xs whitespace-nowrap">${ex}</span>`).join('')}${day.exercises.length > 3 ? `<span class="px-2 py-0.5 bg-gray-700/80 rounded text-xs">+${day.exercises.length - 3}</span>` : ''}</div>` : '<p class="text-xs text-gray-500 italic mt-1">Kh√¥ng c√≥ b√†i t·∫≠p.</p>'}`;
                cont.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderApp() {
            document.getElementById('loading-overlay').style.display = isLoading ? 'flex' : 'none';
            renderHeader();
            if (currentTab === 'today') renderTodayTab();
            else if (currentTab === 'my-workouts') renderMyWorkoutsTab();
            else renderStatsTab();
            lucide.createIcons();
        }

        async function toggleWorkout(objectId) {
            const idx = workouts.findIndex(w => w.objectId === objectId);
            if (idx > -1) {
                const newStatus = !workouts[idx].completed; 
                try { 
                    await Backendless.Data.of('DailyWorkouts').save({ objectId: objectId, completed: newStatus }); 
                    workouts[idx].completed = newStatus; // Update local state *after* successful save
                    updateCurrentDayWeeklyStat(); 
                    renderApp(); 
                }
                catch (e) { 
                    console.error("L·ªói toggle workout:", e); 
                    showMessage("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i b√†i t·∫≠p.", "error"); 
                    // No rollback of local state needed as it was not changed prematurely
                }
            }
        }

        async function addNewWorkoutFromTodayTab() {
            const name = document.getElementById('new-workout-name-today').value.trim();
            const setsStr = document.getElementById('new-workout-sets-today').value.trim();
            const repsStr = document.getElementById('new-workout-reps-today').value.trim();
            const weightStr = document.getElementById('new-workout-weight-today').value.trim();
            const img = document.getElementById('new-workout-image-url-today').value.trim();

            const sets = parseInt(setsStr);
            const reps = parseInt(repsStr);
            let weight = parseFloat(weightStr);
            if (isNaN(weight) || weight < 0) weight = 0; // Default to 0 if invalid or empty

            if (!name || isNaN(sets) || isNaN(reps) || sets <= 0 || reps <= 0) { 
                showMessage("T√™n, Sets, Reps kh√¥ng h·ª£p l·ªá!", "error"); return; 
            }
            
            let masterId;
            // Try to find an existing master workout. For simplicity, match only by name.
            // A more robust match would consider sets/reps/default_weight as well, but that makes it complex.
            // Let's assume for now that if a master workout with the same name exists, we use it.
            // If specific sets/reps/weight are entered, they override the master's defaults for THIS daily entry.
            let existingMaster = allWorkouts.find(w => w.name === name);
            
            if (existingMaster) {
                masterId = existingMaster.objectId;
            } else {
                try { 
                    const masterPayload = { name, num_sets: sets, num_reps: reps, default_weight_kg: weight, image_url: img };
                    // If this app assumes AllWorkouts might be shared, don't add ownerId. If user-specific, add ownerId.
                    // For now, assuming AllWorkouts are general or managed elsewhere if ownerId not present by default.
                    // if(userId) masterPayload.ownerId = userId; // Add if AllWorkouts are user-specific
                    const savedMaster = await Backendless.Data.of('AllWorkouts').save(masterPayload); 
                    masterId = savedMaster.objectId; 
                    allWorkouts.push(savedMaster); 
                }
                catch(e) { console.error("L·ªói th√™m master workout:", e); showMessage("L·ªói th√™m b√†i t·∫≠p ch√≠nh.", "error"); return; }
            }

            const dailyPayload = { 
                master_id: masterId, 
                ownerId: userId, 
                name, 
                num_sets: sets, 
                num_reps: reps, 
                weight_kg: weight,
                volume: sets * reps, 
                image_url: img || (existingMaster ? existingMaster.image_url : ''), // Use existing master image if available
                completed: false, 
                workout_date: getTodayDateString() 
            };

            try {
                const newDaily = await Backendless.Data.of('DailyWorkouts').save(dailyPayload); 
                workouts.push(newDaily); 
                totalWorkouts++; // Increment global total workouts
                updateCurrentDayWeeklyStat(); 
                showMessage("ƒê√£ th√™m b√†i t·∫≠p cho h√¥m nay!", "success");
                ['new-workout-name-today', 'new-workout-sets-today', 'new-workout-reps-today', 'new-workout-weight-today', 'new-workout-image-url-today'].forEach(id => document.getElementById(id).value = '');
                showAddWorkoutFormToday = false; 
                renderApp();
            } catch (e) { console.error("L·ªói th√™m daily workout:", e); showMessage("L·ªói th√™m b√†i t·∫≠p h√¥m nay.", "error"); }
        }

        async function addNewWorkoutFromMyWorkoutsTab() {
            const name = document.getElementById('new-workout-name-my-workouts').value.trim();
            const setsStr = document.getElementById('new-workout-sets-my-workouts').value.trim();
            const repsStr = document.getElementById('new-workout-reps-my-workouts').value.trim();
            const defaultWeightStr = document.getElementById('new-workout-default-weight-my-workouts').value.trim();
            const img = document.getElementById('new-workout-image-url-my-workouts').value.trim();

            const sets = parseInt(setsStr);
            const reps = parseInt(repsStr);
            let defaultWeight = parseFloat(defaultWeightStr);
            if (isNaN(defaultWeight) || defaultWeight < 0) defaultWeight = 0;

            if (!name || isNaN(sets) || isNaN(reps) || sets <= 0 || reps <= 0) { 
                showMessage("T√™n, Sets, Reps kh√¥ng h·ª£p l·ªá!", "error"); return; 
            }
            // Check if a workout with the exact same name, sets, reps, and default weight already exists
            if (allWorkouts.some(w => w.name === name && w.num_sets === sets && w.num_reps === reps && (w.default_weight_kg || 0) === defaultWeight)) { 
                showMessage("B√†i t·∫≠p n√†y ƒë√£ t·ªìn t·∫°i trong danh s√°ch ch√≠nh!", "info"); return; 
            }
            try {
                const masterPayload = { name, num_sets: sets, num_reps: reps, default_weight_kg: defaultWeight, image_url: img };
                // If AllWorkouts are user-specific, add ownerId:
                // if(userId) masterPayload.ownerId = userId; 
                const saved = await Backendless.Data.of('AllWorkouts').save(masterPayload); 
                allWorkouts.push(saved);
                allWorkouts.sort((a,b) => (a.name || "").localeCompare(b.name || "")); // Keep sorted
                showMessage("ƒê√£ th√™m v√†o danh s√°ch ch√≠nh!", "success");
                ['new-workout-name-my-workouts', 'new-workout-sets-my-workouts', 'new-workout-reps-my-workouts', 'new-workout-default-weight-my-workouts', 'new-workout-image-url-my-workouts'].forEach(id => document.getElementById(id).value = '');
                showAddWorkoutFormMyWorkouts = false; 
                renderApp();
            } catch (e) { console.error("L·ªói th√™m master workout:", e); showMessage("L·ªói th√™m b√†i t·∫≠p v√†o danh s√°ch ch√≠nh.", "error"); }
        }

        async function addSelectedWorkoutToToday(masterWorkoutObjectId) {
            const workoutToAdd = allWorkouts.find(w => w.objectId === masterWorkoutObjectId);
            if (workoutToAdd) {
                // Check if this master workout (by master_id) is already added for today
                if (!workouts.some(w => w.master_id === masterWorkoutObjectId && w.workout_date === getTodayDateString())) {
                    const dailyPayload = { 
                        master_id: masterWorkoutObjectId, 
                        ownerId: userId, 
                        name: workoutToAdd.name, 
                        num_sets: workoutToAdd.num_sets, 
                        num_reps: workoutToAdd.num_reps, 
                        weight_kg: workoutToAdd.default_weight_kg != null ? workoutToAdd.default_weight_kg : 0,
                        volume: (workoutToAdd.num_sets || 0) * (workoutToAdd.num_reps || 0), 
                        image_url: workoutToAdd.image_url || '', 
                        completed: false, 
                        workout_date: getTodayDateString() 
                    };
                    try { 
                        const newDaily = await Backendless.Data.of('DailyWorkouts').save(dailyPayload); 
                        workouts.push(newDaily); 
                        totalWorkouts++; 
                        updateCurrentDayWeeklyStat(); 
                        showMessage("ƒê√£ th√™m v√†o b√†i t·∫≠p h√¥m nay!", "success"); 
                        renderApp(); // Re-render to show in Today tab if current, or just update data silently
                    }
                    catch (e) { console.error("L·ªói th√™m selected workout to today:", e); showMessage("L·ªói th√™m b√†i t·∫≠p v√†o h√¥m nay.", "error"); }
                } else showMessage("B√†i t·∫≠p n√†y ƒë√£ c√≥ trong danh s√°ch h√¥m nay!", "info");
            }
        }

        async function removeWorkout(objectId) { // Removes from today's list
            try { 
                await Backendless.Data.of('DailyWorkouts').remove({ objectId }); 
                workouts = workouts.filter(w => w.objectId !== objectId); 
                updateCurrentDayWeeklyStat(); 
                showMessage("ƒê√£ x√≥a b√†i t·∫≠p kh·ªèi h√¥m nay.", "success"); 
                renderApp(); 
            }
            catch (e) { console.error("L·ªói x√≥a daily workout:", e); showMessage("L·ªói x√≥a b√†i t·∫≠p.", "error"); }
        }
        async function removeMasterWorkout(objectId) { // Removes from AllWorkouts (master list)
            // Optional: Add a confirmation dialog here
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i t·∫≠p n√†y kh·ªèi danh s√°ch ch√≠nh? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c v√† c≈©ng s·∫Ω x√≥a l·ªãch s·ª≠ li√™n quan (n·∫øu c√≥ logic d·ªçn d·∫πp).")) {
                return;
            }
            try { 
                await Backendless.Data.of('AllWorkouts').remove({ objectId }); 
                allWorkouts = allWorkouts.filter(w => w.objectId !== objectId); 
                // Optionally, also remove any DailyWorkout entries that reference this master_id if desired,
                // though this might be complex and data-lossy if not handled carefully.
                // For now, just remove from master list. Daily entries with this master_id will just lack some master info.
                // workouts = workouts.filter(w => w.master_id !== objectId); // This would remove from today's list too
                showMessage("ƒê√£ x√≥a b√†i t·∫≠p kh·ªèi danh s√°ch ch√≠nh.", "success"); 
                renderApp(); 
            }
            catch (e) { console.error("L·ªói x√≥a master workout:", e); showMessage("L·ªói x√≥a b√†i t·∫≠p kh·ªèi danh s√°ch ch√≠nh.", "error"); }
        }

        async function handleSignUp() {
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-password').value;
            if (!email || !pass) { showMessage("Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u.", "error"); return; }
            const user = new Backendless.User(); user.email = email; user.password = pass;
            try { 
                await Backendless.UserService.register(user); 
                showMessage("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ x√°c th·ª±c (n·∫øu ƒë∆∞·ª£c c·∫•u h√¨nh). Sau ƒë√≥ ƒëƒÉng nh·∫≠p.", "success"); 
            }
            catch (e) { showMessage(`ƒêƒÉng k√Ω th·∫•t b·∫°i: ${e.message}`, "error"); console.error("L·ªói ƒêƒÉng k√Ω:", e); }
        }
        async function handleSignIn() {
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-password').value;
            if (!email || !pass) { showMessage("Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u.", "error"); return; }
            try { 
                const user = await Backendless.UserService.login(email, pass, true); 
                userId = user.objectId;
                showMessage("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
                document.getElementById('auth-container').style.display = 'none'; 
                document.getElementById('app-container').style.display = 'block';
                currentDayString = getTodayDateString(); // Reset currentDayString upon new login
                await loadDataFromBackendless(); 
                initializeAppAndHandleDailyRollover(); 
                renderApp();
            } catch (e) { showMessage(`ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ${e.message}`, "error"); console.error("L·ªói ƒêƒÉng nh·∫≠p:", e); }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            updateLiveDateTime(); setInterval(updateLiveDateTime, 1000 * 30); // Update time every 30s is enough
            try {
                isLoading = true; // Set loading true before async check
                document.getElementById('loading-overlay').style.display = 'flex';
                lucide.createIcons(); // Create icons for loading spinner

                const currentUser = await Backendless.UserService.getCurrentUser();
                if (currentUser) {
                    userId = currentUser.objectId;
                    document.getElementById('auth-container').style.display = 'none'; 
                    document.getElementById('app-container').style.display = 'block';
                    currentDayString = getTodayDateString(); // Ensure currentDayString is fresh
                    await loadDataFromBackendless(); 
                    initializeAppAndHandleDailyRollover(); 
                    renderApp();
                } else {
                    userId = null; 
                    document.getElementById('auth-container').style.display = 'flex'; 
                    document.getElementById('app-container').style.display = 'none';
                    isLoading = false; 
                    document.getElementById('loading-overlay').style.display = 'none'; 
                    lucide.createIcons(); // Create icons for auth page if needed
                }
            } catch (e) {
                console.error("L·ªói ki·ªÉm tra ƒëƒÉng nh·∫≠p:", e); 
                userId = null;
                document.getElementById('auth-container').style.display = 'flex'; 
                document.getElementById('app-container').style.display = 'none';
                isLoading = false; 
                document.getElementById('loading-overlay').style.display = 'none'; 
                lucide.createIcons();
            } finally {
                 // Ensure loading overlay is hidden if not already
                if (!isLoading && document.getElementById('loading-overlay').style.display !== 'none') {
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            }

            document.getElementById('signup-btn').addEventListener('click', handleSignUp);
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);
            
            ['today', 'my-workouts', 'stats'].forEach(tab => {
                const btn = document.getElementById(`${tab}-tab-btn`);
                if(btn) btn.addEventListener('click', () => {
                    currentTab = tab; 
                    showAddWorkoutFormToday = false; 
                    showAddWorkoutFormMyWorkouts = false; 
                    renderApp();
                });
            });

            const closeModalButton = document.getElementById('close-workout-detail-modal');
            if(closeModalButton) closeModalButton.addEventListener('click', closeWorkoutDetailsModal);
            
            const modalOverlay = document.getElementById('workout-detail-modal');
            if(modalOverlay) modalOverlay.addEventListener('click', (e) => { 
                if (e.target === e.currentTarget) closeWorkoutDetailsModal(); 
            });
            
            // Initial lucide call if not covered by other paths
            if(document.getElementById('app-container').style.display === 'none' && document.getElementById('auth-container').style.display === 'none'){
                 lucide.createIcons();
            }
        });
        window.addEventListener('resize', () => { lucide.createIcons(); }); // Re-render icons on resize
    </script>
</body>
</html>
