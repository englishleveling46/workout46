<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/backendless@7.4.6/dist/backendless.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 4rem; /* Khoảng cách cho bottom nav bar */
        }
        /* Custom styles for Lucide icons to ensure they are rendered */
        [data-lucide] {
            display: inline-block;
        }
        /* Style for the live clock to ensure proper alignment if needed */
        #current-date {
            line-height: 1.4; /* Adjust line height for two lines of text */
        }
        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1a1a1a; /* Slightly lighter dark for modal content */
            border-radius: 1rem;
            padding: 1.5rem; /* 24px */
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-center: center;
            flex: 1;
            padding: 0.5rem;
            color: #9ca3af; /* gray-400 */
            transition: all 0.2s ease;
            border-radius: 0.5rem;
        }
        .bottom-nav-item.active {
            color: #fff;
            background-color: rgba(168, 85, 247, 0.2); /* purple-500/20 */
        }
        .bottom-nav-item:hover:not(.active) {
            color: #d1d5db; /* gray-300 */
            background-color: rgba(255, 255, 255, 0.05);
        }
        .bottom-nav-item i {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white font-inter">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4" style="display: none;">
        <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-6 border border-white/10 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                Fitness Tracker
            </h2>
            <div class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="auth-email" placeholder="email@example.com" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-300 mb-1">Mật khẩu</label>
                    <input type="password" id="auth-password" placeholder="Mật khẩu" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                </div>
                <button id="signup-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold">
                    Đăng ký
                </button>
                <button id="signin-btn" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold">
                    Đăng nhập
                </button>
            </div>
            <p class="text-center text-gray-400 text-xs mt-4">
                Sử dụng email và mật khẩu để đăng nhập hoặc đăng ký.
            </p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <div class="bg-black/20 backdrop-blur-lg border-b border-white/10 sticky top-0 z-50">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl">
                            <i data-lucide="flame" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                Fitness Tracker
                            </h1>
                            <p class="text-xs text-gray-400">Theo dõi tập luyện hàng ngày</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="current-date" class="text-lg font-bold"></div>
                        <div class="text-xs text-gray-400">Thời gian hiện tại</div>
                    </div>
                </div>

                <div id="workout-tabs" class="flex bg-gray-800/50 rounded-xl p-1" style="display: none;">
                    <button id="today-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        Hôm nay
                    </button>
                    <button id="my-workouts-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        Bài tập của tôi
                    </button>
                    <button id="stats-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        Thống kê
                    </button>
                </div>
            </div>
        </div>

        <div id="main-content" class="px-4 py-4 pb-20">
            </div>

        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
            <div class="text-center">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-purple-400 mb-4"></i>
                <p class="text-lg font-medium">Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>

    <div id="message-area" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 p-3 rounded-lg text-white text-center shadow-lg transition-all duration-300 transform -translate-y-full opacity-0" style="min-width: 250px;"></div>

    <div id="workout-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-workout-name" class="text-xl font-bold text-white"></h3>
                <button id="close-workout-detail-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-workout-image-container" class="mb-4 text-center">
                </div>

            <div id="modal-sets-reps-editor" class="bg-gray-800/50 p-3 rounded-lg mb-4" style="display: none;">
                <h4 class="text-md font-semibold mb-3 text-center text-purple-300">Chỉnh sửa Hôm nay</h4>

                <div class="flex items-center justify-between mb-2.5">
                    <label for="modal-sets-input" class="text-sm font-medium text-gray-300">Sets</label>
                    <div class="flex items-center space-x-1.5">
                        <button id="sets-decrement-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                        </button>
                        <input type="number" id="modal-sets-input" class="w-14 bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white text-center text-sm focus:outline-none focus:border-purple-500" min="1" />
                        <button id="sets-increment-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-2.5">
                    <label for="modal-reps-input" class="text-sm font-medium text-gray-300">Reps</label>
                    <div class="flex items-center space-x-1.5">
                        <button id="reps-decrement-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                        </button>
                        <input type="number" id="modal-reps-input" class="w-14 bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white text-center text-sm focus:outline-none focus:border-purple-500" min="1" />
                        <button id="reps-increment-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-3">
                    <label for="modal-weight-input" class="text-sm font-medium text-gray-300">Tạ (kg)</label>
                    <div class="flex items-center space-x-1.5">
                        <button id="weight-decrement-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                        </button>
                        <input type="number" id="modal-weight-input" class="w-20 bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white text-center text-sm focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                        <button id="weight-increment-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>

                <button id="save-workout-details-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold mt-3">
                    Lưu thay đổi
                </button>
            </div>
            
            <div id="modal-workout-history-section" style="display: block;">
                <h4 class="text-lg font-semibold mb-2">Lịch sử 5 ngày gần nhất:</h4>
                <div id="modal-workout-history" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button id="nav-workout-btn" class="bottom-nav-item active">
            <i data-lucide="dumbbell" class="w-5 h-5"></i>
            <span class="text-xs">Bài tập</span>
        </button>
        <button id="nav-habit-btn" class="bottom-nav-item">
            <i data-lucide="check-square" class="w-5 h-5"></i>
            <span class="text-xs">Thói quen</span>
        </button>
    </div>

    <script>
        // Global state variables
        let workouts = []; // Daily workouts
        let allWorkouts = []; // Master list of all workouts
        let habits = []; // Daily habits
        let allHabits = []; // Master list of all habits
        let streak = 0; // Workout streak
        let totalWorkouts = 0; // Total completed workouts
        let weeklyStats = []; // Weekly workout stats
        let currentMainTab = 'workout'; // Main tab: 'workout' or 'habit'
        let currentWorkoutSubTab = 'today'; // Sub-tab for workouts: 'today', 'my-workouts', 'stats'
        let showAddWorkoutFormToday = false; // Show add workout form in 'Today' tab
        let showAddWorkoutFormMyWorkouts = false; // Show add workout form in 'My Workouts' tab
        let showAddHabitForm = false; // Show add habit form in 'Habit' tab
        let isLoading = true; // Loading state

        let currentDayString = new Date().toISOString().split('T')[0]; // Current date in YYYY-MM-DD format
        let streakLastAchievedDate = null; // Last date workout streak was achieved

        const MAX_WEEKLY_STATS_DAYS = 30; // Max days to store in weekly stats
        const MODAL_WEIGHT_ADJUST_STEP = 2.5; // Weight adjustment step in modal


        // Backendless Keys - REPLACE WITH YOUR KEYS
        const BACKENDLESS_APP_ID = 'E1DD6501-EFB3-4E39-BED7-597DE3133D98'; 
        const BACKENDLESS_JS_API_KEY = '8983A173-7621-4F13-924C-3C17494E74EA'; 

        Backendless.initApp(BACKENDLESS_APP_ID, BACKENDLESS_JS_API_KEY);

        let userId = null; // User ID after login

        // Get current date string in YYYY-MM-DD format
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        // Display message
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = message;
            messageArea.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 p-3 rounded-lg text-white text-center shadow-lg transition-all duration-300 transform opacity-100 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500' // Default to blue for 'info'
            }`;
            messageArea.style.transform = 'translateY(0)';
            messageArea.style.opacity = '1';

            setTimeout(() => {
                messageArea.style.transform = 'translateY(-100%)';
                messageArea.style.opacity = '0';
            }, 3000); // Message disappears after 3 seconds
        }

        // Update live date and time
        function updateLiveDateTime() {
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                const dateString = now.toLocaleDateString('vi-VN', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit'
                });
                currentDateElement.innerHTML = `<span class="text-base">${timeString}</span><br>${dateString}`;
            }
        }

        // Load data from Backendless
        async function loadDataFromBackendless() {
            isLoading = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            // Ensure loader icon is rendered if not already
            if (document.querySelector('#loading-overlay [data-lucide="loader-2"]')) { 
                 lucide.createIcons(); // Re-create icon if needed
            }

            if (!userId) {
                console.warn("User not authenticated. Cannot load data from Backendless.");
                isLoading = false;
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }

            try {
                // Load daily workouts for the current user and date
                const dailyWorkoutsQueryBuilder = Backendless.DataQueryBuilder.create()
                    .setWhereClause(`ownerId = '${userId}' AND workout_date = '${getTodayDateString()}'`);
                const dailyWorkoutsData = await Backendless.Data.of('DailyWorkouts').find(dailyWorkoutsQueryBuilder);
                workouts = dailyWorkoutsData || [];

                // Load master list of all workouts
                const allWorkoutsQueryBuilder = Backendless.DataQueryBuilder.create(); 
                // If AllWorkouts are user-specific, add: .setWhereClause(`ownerId = '${userId}'`) 
                // This example assumes AllWorkouts are common, or you'd add ownerId when creating them.
                const allWorkoutsData = await Backendless.Data.of('AllWorkouts').find(allWorkoutsQueryBuilder);
                allWorkouts = allWorkoutsData || [];

                // Load daily habits for the current user and date
                const dailyHabitsQueryBuilder = Backendless.DataQueryBuilder.create()
                    .setWhereClause(`ownerId = '${userId}' AND habit_date = '${getTodayDateString()}'`);
                const dailyHabitsData = await Backendless.Data.of('DailyHabits').find(dailyHabitsQueryBuilder);
                habits = dailyHabitsData || [];

                // Load master list of all habits
                const allHabitsQueryBuilder = Backendless.DataQueryBuilder.create();
                const allHabitsData = await Backendless.Data.of('AllHabits').find(allHabitsQueryBuilder);
                allHabits = allHabitsData || [];

                // Load user stats
                const userStatsQueryBuilder = Backendless.DataQueryBuilder.create()
                    .setWhereClause(`ownerId = '${userId}'`);
                const userStatsData = await Backendless.Data.of('UserStats').find(userStatsQueryBuilder);

                if (userStatsData && userStatsData.length > 0) {
                    const userStats = userStatsData[0];
                    streak = userStats.streak || 0;
                    totalWorkouts = userStats.total_workouts || 0;
                    weeklyStats = userStats.weekly_stats ? JSON.parse(userStats.weekly_stats) : [];
                    streakLastAchievedDate = userStats.streak_last_achieved_date;
                } else {
                    // If no stats, create new
                    const newUserStats = { ownerId: userId, streak: 0, total_workouts: 0, weekly_stats: JSON.stringify([]) };
                    await Backendless.Data.of('UserStats').save(newUserStats);
                }
            } catch (error) {
                console.error("Error loading data from Backendless:", error);
                showMessage(`Error loading data: ${error.message}. Please try again.`, "error");
                // Reset to default state on error
                workouts = []; allWorkouts = []; habits = []; allHabits = []; streak = 0; totalWorkouts = 0; weeklyStats = []; streakLastAchievedDate = null;
            } finally {
                isLoading = false;
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // Save user stats to Backendless
        async function saveDataToBackendless() { // This function specifically saves UserStats
            if (!userId) {
                showMessage("Error: You need to be logged in to save data.", "error");
                return;
            }
            const saveButton = document.getElementById('save-data-to-sheet-btn'); // Assuming this button exists
            const originalButtonHtml = saveButton ? saveButton.innerHTML : '';
            if (saveButton) {
                saveButton.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> <span class="hidden sm:inline">Đang lưu...</span>';
                saveButton.disabled = true;
                lucide.createIcons();
            }

            try {
                const userStatsQueryBuilder = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}'`);
                const existingUserStats = await Backendless.Data.of('UserStats').find(userStatsQueryBuilder);
                let userStatsToSave = {
                    streak: streak, total_workouts: totalWorkouts,
                    weekly_stats: JSON.stringify(weeklyStats), // Convert array to JSON string
                    streak_last_achieved_date: streakLastAchievedDate
                };
                if (existingUserStats && existingUserStats.length > 0) {
                    userStatsToSave.objectId = existingUserStats[0].objectId; // Update existing record
                } else {
                    userStatsToSave.ownerId = userId; // Create new record if none exists
                }
                await Backendless.Data.of('UserStats').save(userStatsToSave);
                if (saveButton) showMessage("Statistical data has been saved!", "success");
            } catch (error) {
                console.error("Error sending UserStats to Backendless:", error);
                showMessage(`Error saving statistical data: ${error.message}.`, "error");
            } finally {
                if (saveButton) {
                    saveButton.innerHTML = originalButtonHtml || '<i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">Lưu dữ liệu</span>'; // Restore button
                    saveButton.disabled = false;
                    lucide.createIcons();
                }
            }
        }
        
        // Initialize app and handle daily rollover
        function initializeAppAndHandleDailyRollover() {
            const todayStr = getTodayDateString();
            if (currentDayString !== todayStr) { // If a new day has passed
                // Calculate metrics for the old day (currentDayString)
                const pastDayActualCompletions = workouts.filter(w => w.completed).length;
                const pastDayTotalTasks = workouts.length;

                // Find if the old day already exists in weeklyStats
                const lastDayStatIndex = weeklyStats.findIndex(s => s.date === currentDayString);

                // If the old day is yesterday relative to the current day (todayStr)
                if (lastDayStatIndex > -1 && new Date(currentDayString).toDateString() === new Date(new Date(todayStr).getTime() - 86400000).toDateString()) {
                    // Update metrics for yesterday if it already exists
                    weeklyStats[lastDayStatIndex].total = pastDayTotalTasks;
                    weeklyStats[lastDayStatIndex].completed = pastDayActualCompletions;
                    weeklyStats[lastDayStatIndex].exercises = workouts.map(w => w.name); // Save names of completed exercises
                } else if (pastDayTotalTasks > 0 || pastDayActualCompletions > 0) { // If not yesterday, but has data, add new
                     weeklyStats.push({
                        date: currentDayString, total: pastDayTotalTasks,
                        completed: pastDayActualCompletions, exercises: workouts.map(w => w.name)
                    });
                }

                // Sort weeklyStats by date descending and limit number of days
                weeklyStats.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (weeklyStats.length > MAX_WEEKLY_STATS_DAYS) weeklyStats = weeklyStats.slice(0, MAX_WEEKLY_STATS_DAYS);

                // Update streak
                if (pastDayTotalTasks > 0 && pastDayActualCompletions === pastDayTotalTasks) { // All workouts completed for the old day
                    if (streakLastAchievedDate) {
                        const expectedPrevStreakDate = new Date(new Date(currentDayString).getTime() - 86400000).toISOString().split('T')[0]; // Expected previous streak date
                        if (streakLastAchievedDate === expectedPrevStreakDate) streak++; else streak = 1; // Reset streak if not consecutive
                    } else streak = 1; // Start new streak
                    streakLastAchievedDate = currentDayString; // Save streak date
                } else {
                    // If old day was yesterday and not all completed, reset streak
                    const yesterdayStr = new Date(new Date(todayStr).getTime() - 86400000).toISOString().split('T')[0];
                    if (currentDayString === yesterdayStr && pastDayTotalTasks > 0) { // Only reset if there were workouts yesterday
                        streak = 0; 
                        streakLastAchievedDate = null; // Reset streak date
                    }
                    // If not yesterday, do nothing with streak (avoid unnecessary reset)
                }
                workouts = []; // Reset workouts for the new day
                currentDayString = todayStr; // Update current day
            }
            updateCurrentDayWeeklyStat(); // Update stats for the current day (can be new day or same day if not past midnight)
        }

        // Update current day's stats in weeklyStats
        function updateCurrentDayWeeklyStat() {
            if (!currentDayString) return; // No current day yet
            const todayActualCompletions = workouts.filter(w => w.completed).length;
            const todayTotalTasks = workouts.length;
            const todayStatPayload = {
                date: currentDayString, total: todayTotalTasks,
                completed: todayActualCompletions, exercises: workouts.map(w => w.name)
            };
            const existingStatIndex = weeklyStats.findIndex(s => s.date === currentDayString);
            if (existingStatIndex > -1) weeklyStats[existingStatIndex] = todayStatPayload; // Update if exists
            else weeklyStats.push(todayStatPayload); // Add new if not exists
            
            weeklyStats.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort
            if (weeklyStats.length > MAX_WEEKLY_STATS_DAYS) weeklyStats = weeklyStats.slice(0, MAX_WEEKLY_STATS_DAYS); // Limit days

            saveDataToBackendless(); // Save user stats
        }

        // Utility functions to get statistical information
        function getCompletedCount() { return workouts.filter(w => w.completed).length; }
        function getCompletionRate() { const c = getCompletedCount(); return workouts.length > 0 ? Math.round((c / workouts.length) * 100) : 0; }
        function formatDate(dateString) { // Format date (e.g., T2, 28/05)
            const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() + userTimezoneOffset); // Adjust timezone
            return localDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', weekday: 'short' });
        }
        function getWeeklyAverage() { // Average completion rate for the last 7 days
            if (weeklyStats.length === 0) return 0; const relevantStats = weeklyStats.slice(0, 7);
            const totalCompleted = relevantStats.reduce((sum, day) => sum + day.completed, 0);
            const totalPossible = relevantStats.reduce((sum, day) => sum + day.total, 0);
            return totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        }
        function getMostActiveDay() { // Day with most completed workouts
            if (weeklyStats.length === 0) return 'Chưa có'; let maxCompleted = -1; let mostActiveDayData = null;
            for (const day of weeklyStats) { if (day.completed > maxCompleted) { maxCompleted = day.completed; mostActiveDayData = day; } }
            return mostActiveDayData && maxCompleted > 0 ? formatDate(mostActiveDayData.date) : 'Chưa có';
        }
        function getCurrentWeekTotalCompleted() { const r = weeklyStats.slice(0, 7); return r.reduce((s, d) => s + d.completed, 0); }

        // Render header (sub-tabs for workouts)
        function renderWorkoutSubTabs() {
            const todayTabBtn = document.getElementById('today-tab-btn');
            const myWorkoutsTabBtn = document.getElementById('my-workouts-tab-btn');
            const statsTabBtn = document.getElementById('stats-tab-btn');
            const workoutTabsContainer = document.getElementById('workout-tabs');

            if (currentMainTab === 'workout') {
                workoutTabsContainer.style.display = 'flex';
                const baseClass = "flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all";
                const activeClass = "bg-gradient-to-r from-purple-500 to-pink-500 text-white";
                const inactiveClass = "text-gray-400 hover:text-white";
                todayTabBtn.className = `${baseClass} ${currentWorkoutSubTab === 'today' ? activeClass : inactiveClass}`;
                myWorkoutsTabBtn.className = `${baseClass} ${currentWorkoutSubTab === 'my-workouts' ? activeClass : inactiveClass}`;
                statsTabBtn.className = `${baseClass} ${currentWorkoutSubTab === 'stats' ? activeClass : inactiveClass}`;
            } else {
                workoutTabsContainer.style.display = 'none';
            }
        }

        // Render content for "Today" tab (Workout section)
        function renderTodayWorkoutTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-green-500/20 to-green-600/20 backdrop-blur-lg rounded-xl p-3 border border-green-500/30 text-center">
                        <i data-lucide="check-circle-2" class="w-6 h-6 text-green-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${getCompletedCount()}</p><p class="text-xs text-green-300">Hoàn thành</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500/20 to-red-500/20 backdrop-blur-lg rounded-xl p-3 border border-orange-500/30 text-center">
                        <i data-lucide="flame" class="w-6 h-6 text-orange-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${streak}</p><p class="text-xs text-orange-300">Ngày liên tiếp</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 backdrop-blur-lg rounded-xl p-3 border border-blue-500/30 text-center">
                        <i data-lucide="trophy" class="w-6 h-6 text-blue-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${getCompletionRate()}%</p><p class="text-xs text-blue-300">Tiến độ</p>
                    </div>
                </div>
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 mb-6 border border-white/10">
                    <div class="flex items-center justify-between mb-3"><h3 class="font-semibold">Tiến độ hôm nay</h3><span class="text-sm text-gray-400">${getCompletedCount()}/${workouts.length}</span></div>
                    <div class="w-full bg-gray-700 rounded-full h-3 mb-2"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: ${getCompletionRate()}%"></div></div>
                    <p class="text-xs text-gray-400 text-center">${getCompletionRate() === 100 && workouts.length > 0 ? '🎉 Xuất sắc! Hoàn thành tất cả bài tập!' : workouts.length > 0 ? `Còn ${workouts.length - getCompletedCount()} bài tập nữa` : 'Thêm bài tập cho hôm nay!'}</p>
                </div>
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden mb-6">
                    <div class="p-4 border-b border-white/10">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-bold">Bài tập hôm nay</h2>
                            <div class="flex space-x-2">
                                <button id="save-data-to-sheet-btn" class="flex items-center space-x-1 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                                    <i data-lucide="save" class="w-4 h-4"></i><span class="hidden sm:inline">Lưu dữ liệu</span>
                                </button>
                                <button id="add-workout-today-btn" class="flex items-center space-x-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                                    <i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Thêm</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="add-new-workout-form-today" class="p-4 bg-gray-800/50 border-b border-white/10" style="display: ${showAddWorkoutFormToday ? 'block' : 'none'};">
                        <div class="flex justify-end mb-3"><button id="close-add-form-today-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input type="text" id="new-workout-name-today" placeholder="Tên bài tập" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                            <input type="number" id="new-workout-sets-today" placeholder="Số Sets" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-reps-today" placeholder="Số Reps" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-weight-today" placeholder="Tạ (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                            <input type="text" id="new-workout-image-url-today" placeholder="URL hình ảnh (tùy chọn)" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                        </div>
                        <div class="flex space-x-3 mt-3"><button id="add-new-workout-today-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors text-sm">Thêm vào hôm nay</button></div>
                    </div>
                    <div id="workout-list-container" class="p-4 space-y-3"></div>
                </div>`;
            // Attach event listeners for buttons
            document.getElementById('add-workout-today-btn').onclick = () => { showAddWorkoutFormToday = true; renderApp(); };
            document.getElementById('save-data-to-sheet-btn').onclick = saveDataToBackendless; 
            if (showAddWorkoutFormToday) {
                document.getElementById('close-add-form-today-btn').onclick = () => { showAddWorkoutFormToday = false; renderApp(); };
                document.getElementById('add-new-workout-today-btn').onclick = addNewWorkoutFromTodayTab;
            }
            renderWorkoutItems(); // Render workout list
            lucide.createIcons(); // Create icons
        }

        // Render workout items in "Today" tab
        async function renderWorkoutItems() {
            const workoutListContainer = document.getElementById('workout-list-container');
            if (!workoutListContainer) return;
            workoutListContainer.innerHTML = workouts.length === 0 ? '<p class="text-center text-gray-400 py-4">Chưa có bài tập nào.</p>' : '';

            for (const workout of workouts) {
                const workoutItem = document.createElement('div');
                workoutItem.className = `group flex items-center justify-between p-3 rounded-xl border transition-all duration-200 ${workout.completed ? 'bg-green-500/10 border-green-500/30' : 'bg-gray-800/50 border-gray-700'}`;
                
                // Compare with previous session
                const currentVolume = (workout.num_sets || 0) * (workout.num_reps || 0); // Can add * weight if comparing weighted volume
                const comparisonResult = await getPreviousWorkoutPerformance(workout.master_id, currentVolume);
                let comparisonIcon = '', comparisonColor = 'text-gray-400';
                if (comparisonResult === 'increased') { comparisonIcon = '<i data-lucide="arrow-up" class="w-4 h-4 text-green-400"></i>'; comparisonColor = 'text-green-400'; }
                else if (comparisonResult === 'decreased') { comparisonIcon = '<i data-lucide="arrow-down" class="w-4 h-4 text-red-400"></i>'; comparisonColor = 'text-red-400'; }
                else if (comparisonResult === 'same') { comparisonIcon = '<i data-lucide="minus" class="w-4 h-4 text-blue-400"></i>'; comparisonColor = 'text-blue-400'; }
                else { comparisonIcon = '<i data-lucide="info" class="w-4 h-4 text-gray-400"></i>'; } // 'no_data'

                workoutItem.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1">
                        <button class="toggle-workout-btn transition-colors hover:scale-110 transform flex-shrink-0" data-id="${workout.objectId}">
                            ${workout.completed ? '<i data-lucide="check-circle-2" class="w-5 h-5 text-green-400"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-gray-400 hover:text-green-400"></i>'}
                        </button>
                        <div class="flex items-center space-x-3 flex-1 cursor-pointer workout-details-trigger" data-master-id="${workout.master_id}" data-workout-name="${workout.name}" data-image-url="${workout.image_url || ''}" data-object-id="${workout.objectId}">
                            ${workout.image_url ? `<img src="${workout.image_url}" alt="${workout.name}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/48x48/6b7280/ffffff?text=NoImg';"/>` : `<div class="w-12 h-12 flex items-center justify-center bg-gray-700 rounded-lg flex-shrink-0"><i data-lucide="image" class="w-6 h-6 text-gray-400"></i></div>`}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2">
                                    <h3 class="font-medium text-sm ${workout.completed ? 'text-green-400 line-through' : 'text-white'} truncate">${workout.name}</h3>
                                    <span class="text-xs ${comparisonColor}">${comparisonIcon}</span>
                                </div>
                                <p class="text-gray-400 text-xs mt-1">${workout.num_sets} sets x ${workout.num_reps} reps @ ${workout.weight_kg != null ? workout.weight_kg : '0'}kg</p>
                            </div>
                        </div>
                    </div>
                    <button class="remove-workout-btn opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-all duration-200 ml-2 flex-shrink-0" data-id="${workout.objectId}"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                workoutListContainer.appendChild(workoutItem);
            }
            // Attach event listeners for toggle, remove, and workout detail modal buttons
            document.querySelectorAll('.toggle-workout-btn').forEach(b => { b.onclick = (e) => toggleWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('.remove-workout-btn').forEach(b => { b.onclick = (e) => removeWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('#workout-list-container .workout-details-trigger').forEach(el => {
                el.onclick = (e) => showWorkoutDetails(e.currentTarget.dataset.masterId, e.currentTarget.dataset.workoutName, e.currentTarget.dataset.imageUrl, e.currentTarget.dataset.objectId);
            });
            lucide.createIcons();
        }

        // Get previous workout performance for comparison
        async function getPreviousWorkoutPerformance(masterId, currentVolume) {
            if (!masterId) return 'no_data'; // No master_id, no history to compare
            const qb = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}' AND master_id = '${masterId}' AND workout_date < '${getTodayDateString()}'`).setSortBy(['workout_date DESC']).setPageSize(1);
            const data = await Backendless.Data.of('DailyWorkouts').find(qb);
            if (data && data.length > 0) {
                const prevVol = (data[0].num_sets || 0) * (data[0].num_reps || 0); // Can add * weight if desired
                if (currentVolume > prevVol) return 'increased'; if (currentVolume < prevVol) return 'decreased'; return 'same';
            } return 'no_data'; // No previous data
        }
        
        // Utility function to rebind listeners to an element (avoids listener stacking)
        function rebindListeners(elementId, newOnClick) {
            const originalElement = document.getElementById(elementId);
            if (!originalElement) return null;
            const newElement = originalElement.cloneNode(true); // Clone element
            originalElement.parentNode.replaceChild(newElement, originalElement); // Replace old element with new
            if (newOnClick) {
                newElement.onclick = newOnClick; // Attach new listener
            }
            return newElement; // Return the new element with attached listener
        }

        // Display workout detail modal
        async function showWorkoutDetails(masterId, workoutName, imageUrl, currentWorkoutObjectId = null) {
            const modal = document.getElementById('workout-detail-modal');
            const modalWorkoutName = document.getElementById('modal-workout-name');
            const modalWorkoutImageContainer = document.getElementById('modal-workout-image-container');
            
            const modalSetsRepsEditor = document.getElementById('modal-sets-reps-editor');
            const modalSetsInput = document.getElementById('modal-sets-input');
            const modalRepsInput = document.getElementById('modal-reps-input');
            const modalWeightInput = document.getElementById('modal-weight-input');

            const modalWorkoutHistorySection = document.getElementById('modal-workout-history-section');
            const modalWorkoutHistory = document.getElementById('modal-workout-history');

            modalWorkoutName.textContent = workoutName;
            // Handle image display or placeholder
            if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined' || imageUrl.trim() === '') {
                modalWorkoutImageContainer.innerHTML = `<div class="w-full h-48 flex items-center justify-center bg-gray-700 rounded-lg"><i data-lucide="image" class="w-24 h-24 text-gray-400"></i></div>`;
            } else {
                modalWorkoutImageContainer.innerHTML = `<img src="${imageUrl}" alt="Workout Image" class="w-full h-48 object-contain rounded-lg" onerror="this.onerror=null;this.parentElement.innerHTML = '<div class=\\'w-full h-48 flex items-center justify-center bg-gray-700 rounded-lg\\'><i data-lucide=\\'image-off\\' class=\\'w-24 h-24 text-gray-400\\'></i></div>'; lucide.createIcons();" />`;
            }
            
            if (currentWorkoutObjectId) { // If opened from "Today" tab (has objectId of today's workout)
                modalSetsRepsEditor.style.display = 'block'; // Show edit form
                if (modalWorkoutHistorySection) modalWorkoutHistorySection.style.display = 'none'; // Hide history

                const currentWorkout = workouts.find(w => w.objectId === currentWorkoutObjectId);
                if (currentWorkout) {
                    modalSetsInput.value = currentWorkout.num_sets;
                    modalRepsInput.value = currentWorkout.num_reps;
                    modalWeightInput.value = currentWorkout.weight_kg != null ? currentWorkout.weight_kg : 0;
                } else {
                    // Fallback if workout not found (rare case)
                    modalSetsInput.value = 1; modalRepsInput.value = 1; modalWeightInput.value = 0;
                    console.warn(`Workout with objectId ${currentWorkoutObjectId} not found for modal editor.`);
                }

                // Rebind listeners for +/- and Save buttons using rebindListeners to avoid issues
                rebindListeners('sets-decrement-btn', () => {
                    const cv = parseInt(modalSetsInput.value); modalSetsInput.value = Math.max(1, (isNaN(cv) ? 2 : cv) - 1);
                });
                rebindListeners('sets-increment-btn', () => {
                    const cv = parseInt(modalSetsInput.value); modalSetsInput.value = (isNaN(cv) ? 0 : cv) + 1;
                });
                rebindListeners('reps-decrement-btn', () => {
                    const cv = parseInt(modalRepsInput.value); modalRepsInput.value = Math.max(1, (isNaN(cv) ? 2 : cv) - 1);
                });
                rebindListeners('reps-increment-btn', () => {
                    const cv = parseInt(modalRepsInput.value); modalRepsInput.value = (isNaN(cv) ? 0 : cv) + 1;
                });
                rebindListeners('weight-decrement-btn', () => {
                    const cv = parseFloat(modalWeightInput.value); 
                    let newVal = (isNaN(cv) ? MODAL_WEIGHT_ADJUST_STEP : cv) - MODAL_WEIGHT_ADJUST_STEP;
                    modalWeightInput.value = Math.max(0, newVal).toFixed(2);
                });
                rebindListeners('weight-increment-btn', () => {
                    const cv = parseFloat(modalWeightInput.value); 
                    let newVal = (isNaN(cv) ? -MODAL_WEIGHT_ADJUST_STEP : cv) + MODAL_WEIGHT_ADJUST_STEP;
                    modalWeightInput.value = newVal.toFixed(2);
                });
                rebindListeners('save-workout-details-btn', () => {
                    const newSets = parseInt(modalSetsInput.value); 
                    const newReps = parseInt(modalRepsInput.value);
                    const newWeight = parseFloat(modalWeightInput.value);

                    if (!isNaN(newSets) && !isNaN(newReps) && !isNaN(newWeight) && newSets > 0 && newReps > 0 && newWeight >= 0) {
                        updateWorkoutDetails(currentWorkoutObjectId, newSets, newReps, newWeight);
                    } else { showMessage("Sets, Reps must be positive numbers and Weight must be non-negative!", "error"); }
                });

            } else { // If opened from "My Workouts" tab (only masterId, no objectId of today's workout)
                modalSetsRepsEditor.style.display = 'none'; // Hide edit form
                if (modalWorkoutHistorySection) modalWorkoutHistorySection.style.display = 'block'; // Show history
                if (!masterId) {
                     modalWorkoutHistory.innerHTML = '<p class="text-center text-gray-400">No master ID to load history.</p>';
                } else {
                    // Load and display history of the last 5 sessions for this workout
                    const queryBuilder = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}' AND master_id = '${masterId}'`).setSortBy(['workout_date DESC']).setPageSize(5);
                    try {
                        const historyData = await Backendless.Data.of('DailyWorkouts').find(queryBuilder);
                        modalWorkoutHistory.innerHTML = ''; // Clear old history
                        if (historyData && historyData.length > 0) {
                            historyData.forEach(entry => { 
                                const item = document.createElement('div'); item.className = 'flex justify-between items-center bg-gray-800/50 p-3 rounded-lg';
                                item.innerHTML = `<span class="text-sm font-medium">${formatDate(entry.workout_date)}</span><span class="text-sm text-gray-300">${entry.num_sets}x${entry.num_reps} @ ${entry.weight_kg != null ? entry.weight_kg : '0'}kg</span>`;
                                modalWorkoutHistory.appendChild(item);
                            });
                        } else { modalWorkoutHistory.innerHTML = '<p class="text-center text-gray-400">No history yet.</p>'; }
                    } catch (error) {
                        console.error("Error loading workout history:", error);
                        modalWorkoutHistory.innerHTML = '<p class="text-center text-red-400">Error loading history.</p>';
                    }
                }
            }
            modal.classList.add('open'); // Open modal
            lucide.createIcons(); // Create icons
        }

        // Close workout detail modal
        function closeWorkoutDetailsModal() { document.getElementById('workout-detail-modal').classList.remove('open'); }

        // Update workout details (Sets, Reps, Weight)
        async function updateWorkoutDetails(objectId, newSets, newReps, newWeight) {
            const workoutIndex = workouts.findIndex(w => w.objectId === objectId);
            if (workoutIndex > -1) {
                const updatedWorkoutData = { 
                    objectId: objectId, 
                    num_sets: newSets, 
                    num_reps: newReps, 
                    weight_kg: newWeight,
                    volume: newSets * newReps // Update volume if needed
                };
                try {
                    await Backendless.Data.of('DailyWorkouts').save(updatedWorkoutData); // Save to Backendless
                    // Update local workouts array
                    workouts[workoutIndex].num_sets = newSets; 
                    workouts[workoutIndex].num_reps = newReps; 
                    workouts[workoutIndex].weight_kg = newWeight;
                    workouts[workoutIndex].volume = newSets * newReps;
                    updateCurrentDayWeeklyStat(); // Update daily stats
                    showMessage("Workout details updated!", "success");
                    closeWorkoutDetailsModal(); // Close modal
                    renderApp(); // Re-render UI
                } catch (error) { console.error("Error updating workout details:", error); showMessage("Error updating workout details.", "error"); }
            }
        }

        // Render content for "My Workouts" tab (Workout section)
        function renderMyWorkoutsTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden mb-6">
                    <div class="p-4 border-b border-white/10"><div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold">Tất cả bài tập của tôi</h2>
                        <button id="add-workout-my-workouts-btn" class="flex items-center space-x-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Thêm bài tập mới</span>
                        </button></div></div>
                    <div id="add-new-workout-form-my-workouts" class="p-4 bg-gray-800/50 border-b border-white/10" style="display: ${showAddWorkoutFormMyWorkouts ? 'block' : 'none'};">
                        <div class="flex justify-end mb-3"><button id="close-add-form-my-workouts-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input type="text" id="new-workout-name-my-workouts" placeholder="Tên bài tập" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                            <input type="number" id="new-workout-sets-my-workouts" placeholder="Số Sets" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-reps-my-workouts" placeholder="Số Reps" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-default-weight-my-workouts" placeholder="Tạ mặc định (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                            <input type="text" id="new-workout-image-url-my-workouts" placeholder="URL hình ảnh (tùy chọn)" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                        </div>
                        <div class="flex space-x-3 mt-3"><button id="add-new-workout-my-workouts-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors text-sm">Thêm vào danh sách chính</button></div>
                    </div>
                    <div id="all-workouts-list-container" class="p-4 space-y-3"></div>
                </div>`;
            // Attach event listeners for buttons
            document.getElementById('add-workout-my-workouts-btn').onclick = () => { showAddWorkoutFormMyWorkouts = true; renderApp(); };
            if (showAddWorkoutFormMyWorkouts) {
                document.getElementById('close-add-form-my-workouts-btn').onclick = () => { showAddWorkoutFormMyWorkouts = false; renderApp(); };
                document.getElementById('add-new-workout-my-workouts-btn').onclick = addNewWorkoutFromMyWorkoutsTab;
            }
            renderAllWorkoutItems(); // Render all workout items
            lucide.createIcons();
        }

        // Render master list of all workouts
        function renderAllWorkoutItems() {
            const cont = document.getElementById('all-workouts-list-container'); if (!cont) return;
            cont.innerHTML = allWorkouts.length === 0 ? '<p class="text-center text-gray-400 py-4">Chưa có bài tập nào.</p>' : '';
            allWorkouts.sort((a,b) => (a.name || "").localeCompare(b.name || "")).forEach(w => { // Sort by name
                const item = document.createElement('div'); item.className = `flex items-center justify-between p-3 rounded-xl border bg-gray-800/50 border-gray-700`;
                item.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1 cursor-pointer workout-details-trigger" data-master-id="${w.objectId}" data-workout-name="${w.name}" data-image-url="${w.image_url || ''}">
                        ${w.image_url ? `<img src="${w.image_url}" alt="${w.name}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/48x48/6b7280/ffffff?text=NoImg';"/>` : `<div class="w-12 h-12 flex items-center justify-center bg-gray-700 rounded-lg flex-shrink-0"><i data-lucide="image" class="w-6 h-6 text-gray-400"></i></div>`}
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm text-white truncate">${w.name}</h3>
                            <p class="text-gray-400 text-xs mt-1">${w.num_sets}x${w.num_reps} @ ${w.default_weight_kg != null ? w.default_weight_kg : '0'}kg (mặc định)</p>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-2 flex-shrink-0">
                        <button class="add-to-today-btn bg-green-500 hover:bg-green-600 p-2 rounded-lg text-xs transition-colors" data-id="${w.objectId}"><i data-lucide="calendar-plus" class="w-4 h-4"></i></button>
                        <button class="remove-master-workout-btn text-red-400 hover:text-red-300 transition-all duration-200" data-id="${w.objectId}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                cont.appendChild(item);
            });
            // Attach event listeners for buttons
            document.querySelectorAll('.add-to-today-btn').forEach(b => { b.onclick = (e) => addSelectedWorkoutToToday(e.currentTarget.dataset.id); });
            document.querySelectorAll('.remove-master-workout-btn').forEach(b => { b.onclick = (e) => removeMasterWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('#all-workouts-list-container .workout-details-trigger').forEach(el => {
                // When clicking on a workout, show detail modal (history only, no editing)
                el.onclick = (e) => showWorkoutDetails(e.currentTarget.dataset.masterId, e.currentTarget.dataset.workoutName, e.currentTarget.dataset.imageUrl, null);
            });
            lucide.createIcons();
        }

        // Render content for "Stats" tab (Workout section)
        function renderStatsWorkoutTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-lg rounded-xl p-4 border border-purple-500/30 text-center">
                            <i data-lucide="activity" class="w-8 h-8 text-purple-400 mx-auto mb-2"></i><p class="text-2xl font-bold">${getCurrentWeekTotalCompleted()}</p><p class="text-xs text-purple-300">Bài tập (7 ngày)</p></div>
                        <div class="bg-gradient-to-br from-green-500/20 to-blue-500/20 backdrop-blur-lg rounded-xl p-4 border border-green-500/30 text-center">
                            <i data-lucide="award" class="w-8 h-8 text-green-400 mx-auto mb-2"></i><p class="text-2xl font-bold">${getWeeklyAverage()}%</p><p class="text-xs text-green-300">TB hoàn thành (7 ngày)</p></div>
                    </div>
                    <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 border border-white/10">
                        <h3 class="text-lg font-bold mb-4 flex items-center"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-purple-400"></i>Lịch sử hoạt động</h3>
                        <div id="weekly-stats-container" class="space-y-3"></div></div>
                    <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 border border-white/10">
                        <h3 class="text-lg font-bold mb-4 flex items-center"><i data-lucide="trophy" class="w-5 h-5 mr-2 text-yellow-400"></i>Thành tích</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-orange-500/20 rounded-lg"><i data-lucide="flame" class="w-5 h-5 text-orange-400"></i></div><div><p class="font-medium">Chuỗi ngày liên tiếp</p><p class="text-sm text-gray-400">Tập luyện đều đặn</p></div></div><span class="text-xl font-bold text-orange-400">${streak} ngày</span></div>
                            <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-green-500/20 rounded-lg"><i data-lucide="calendar" class="w-5 h-5 text-green-400"></i></div><div><p class="font-medium">Ngày tích cực nhất</p><p class="text-sm text-gray-400">Hoàn thành nhiều nhất</p></div></div><span class="text-sm font-bold text-green-400">${getMostActiveDay()}</span></div>
                            <div class="flex items-center justify-between p-3 bg-blue-500/20 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-blue-500/20 rounded-lg"><i data-lucide="trending-up" class="w-5 h-5 text-blue-400"></i></div><div><p class="font-medium">Tổng bài tập</p><p class="text-sm text-gray-400">Từ khi bắt đầu</p></div></div><span class="text-xl font-bold text-blue-400">${totalWorkouts}</span></div>
                        </div></div></div>`;
            renderWeeklyStatsHistory(); // Render weekly stats history
            lucide.createIcons();
        }

        // Render weekly workout stats history
        function renderWeeklyStatsHistory() {
            const cont = document.getElementById('weekly-stats-container'); if (!cont) return;
            cont.innerHTML = weeklyStats.length === 0 ? '<p class="text-center text-gray-400 py-4">Chưa có dữ liệu thống kê.</p>' : '';
            weeklyStats.forEach(day => {
                const perc = day.total > 0 ? (day.completed / day.total) * 100 : 0;
                const isToday = day.date === getTodayDateString();
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg ${isToday && day.date === currentDayString ? 'bg-purple-500/20 border border-purple-500/30' : 'bg-gray-800/50'}`; // Highlight current day
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2"><span class="text-sm font-medium">${formatDate(day.date)}${isToday && day.date === currentDayString ? '<span class="text-purple-400 ml-1">(Hôm nay)</span>' : ''}</span></div>
                        <span class="text-sm text-gray-400">${day.completed}/${day.total}</span></div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-1"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${perc}%"></div></div>
                    ${day.exercises && day.exercises.length > 0 ? `<div class="flex flex-wrap gap-1 mt-2">${day.exercises.slice(0,3).map(ex => `<span class="px-2 py-0.5 bg-gray-700/80 rounded text-xs whitespace-nowrap">${ex}</span>`).join('')}${day.exercises.length > 3 ? `<span class="px-2 py-0.5 bg-gray-700/80 rounded text-xs">+${day.exercises.length - 3}</span>` : ''}</div>` : '<p class="text-xs text-gray-500 italic mt-1">Không có bài tập.</p>'}`;
                cont.appendChild(item);
            });
            lucide.createIcons();
        }

        // Render content for "Habit" tab
        function renderHabitTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 mb-6 border border-white/10">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold">Tiến độ thói quen hôm nay</h3>
                        <span class="text-sm text-gray-400">${habits.filter(h => h.completed).length}/${habits.length}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3 mb-2">
                        <div class="bg-gradient-to-r from-teal-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: ${habits.length > 0 ? Math.round((habits.filter(h => h.completed).length / habits.length) * 100) : 0}%"></div>
                    </div>
                    <p class="text-xs text-gray-400 text-center">
                        ${habits.length > 0 && habits.filter(h => h.completed).length === habits.length ? '🎉 Tuyệt vời! Hoàn thành tất cả thói quen!' : habits.length > 0 ? `Còn ${habits.length - habits.filter(h => h.completed).length} thói quen nữa` : 'Thêm thói quen cho hôm nay!'}
                    </p>
                </div>

                <div class="bg-black/30 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden mb-6">
                    <div class="p-4 border-b border-white/10">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-bold">Thói quen hàng ngày</h2>
                            <button id="add-habit-btn" class="flex items-center space-x-1 bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                                <i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Thêm thói quen</span>
                            </button>
                        </div>
                    </div>
                    <div id="add-new-habit-form" class="p-4 bg-gray-800/50 border-b border-white/10" style="display: ${showAddHabitForm ? 'block' : 'none'};">
                        <div class="flex justify-end mb-3"><button id="close-add-habit-form-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <input type="text" id="new-habit-name" placeholder="Tên thói quen (ví dụ: Tắm, Giặt đồ, Ngủ trước 11h)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-teal-500" />
                        <button id="add-new-habit-btn" class="w-full bg-teal-500 hover:bg-teal-600 px-4 py-2 rounded-lg transition-colors text-sm mt-3">Thêm thói quen</button>
                    </div>
                    <div id="habit-list-container" class="p-4 space-y-3"></div>
                </div>

                <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 border border-white/10">
                    <h3 class="text-lg font-bold mb-4 flex items-center"><i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-teal-400"></i>Thống kê thói quen</h3>
                    <div id="habit-stats-container" class="space-y-3">
                        <p class="text-center text-gray-400 py-4">Chưa có dữ liệu thống kê thói quen.</p>
                    </div>
                </div>
            `;
            // Attach event listeners
            document.getElementById('add-habit-btn').onclick = () => { showAddHabitForm = true; renderApp(); };
            if (showAddHabitForm) {
                document.getElementById('close-add-habit-form-btn').onclick = () => { showAddHabitForm = false; renderApp(); };
                document.getElementById('add-new-habit-btn').onclick = addNewHabit;
            }
            renderHabitItems(); // Render habit list
            renderHabitStats(); // Render habit stats
            lucide.createIcons();
        }

        // Render habit items in "Habit" tab
        function renderHabitItems() {
            const habitListContainer = document.getElementById('habit-list-container');
            if (!habitListContainer) return;
            habitListContainer.innerHTML = habits.length === 0 ? '<p class="text-center text-gray-400 py-4">Chưa có thói quen nào.</p>' : '';

            habits.forEach(habit => {
                const habitItem = document.createElement('div');
                habitItem.className = `group flex items-center justify-between p-3 rounded-xl border transition-all duration-200 ${habit.completed ? 'bg-teal-500/10 border-teal-500/30' : 'bg-gray-800/50 border-gray-700'}`;
                
                habitItem.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1">
                        <button class="toggle-habit-btn transition-colors hover:scale-110 transform flex-shrink-0" data-id="${habit.objectId}">
                            ${habit.completed ? '<i data-lucide="check-circle-2" class="w-5 h-5 text-teal-400"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-gray-400 hover:text-teal-400"></i>'}
                        </button>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm ${habit.completed ? 'text-teal-400 line-through' : 'text-white'} truncate">${habit.name}</h3>
                        </div>
                    </div>
                    <button class="remove-habit-btn opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-all duration-200 ml-2 flex-shrink-0" data-id="${habit.objectId}"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                habitListContainer.appendChild(habitItem);
            });
            // Attach event listeners
            document.querySelectorAll('.toggle-habit-btn').forEach(b => { b.onclick = (e) => toggleHabit(e.currentTarget.dataset.id); });
            document.querySelectorAll('.remove-habit-btn').forEach(b => { b.onclick = (e) => removeHabit(e.currentTarget.dataset.id); });
            lucide.createIcons();
        }

        // Render habit statistics
        async function renderHabitStats() {
            const habitStatsContainer = document.getElementById('habit-stats-container');
            if (!habitStatsContainer) return;

            // Fetch all habit entries for the current user to calculate statistics
            const allDailyHabitsQueryBuilder = Backendless.DataQueryBuilder.create()
                .setWhereClause(`ownerId = '${userId}'`)
                .setSortBy(['habit_date DESC']);
            const allDailyHabits = await Backendless.Data.of('DailyHabits').find(allDailyHabitsQueryBuilder);

            // Group habits by name and calculate completion count
            const habitCompletionCounts = {};
            const habitDailyRecords = {}; // To track daily completion for streak
            allDailyHabits.forEach(entry => {
                if (!habitCompletionCounts[entry.name]) {
                    habitCompletionCounts[entry.name] = { total: 0, completed: 0, streak: 0, lastCompletedDate: null };
                }
                habitCompletionCounts[entry.name].total++;
                if (entry.completed) {
                    habitCompletionCounts[entry.name].completed++;
                }

                // Track daily records for streak calculation
                if (!habitDailyRecords[entry.name]) {
                    habitDailyRecords[entry.name] = {};
                }
                habitDailyRecords[entry.name][entry.habit_date] = entry.completed;
            });

            // Calculate streaks for each habit
            for (const habitName in habitCompletionCounts) {
                let currentHabitStreak = 0;
                let lastDate = null;
                const sortedDates = Object.keys(habitDailyRecords[habitName]).sort(); // Sort dates ascending

                for (let i = 0; i < sortedDates.length; i++) {
                    const date = sortedDates[i];
                    const completed = habitDailyRecords[habitName][date];

                    if (completed) {
                        if (lastDate) {
                            const prevDay = new Date(new Date(date).getTime() - 86400000).toISOString().split('T')[0];
                            if (prevDay === lastDate) {
                                currentHabitStreak++;
                            } else {
                                currentHabitStreak = 1; // Reset if not consecutive
                            }
                        } else {
                            currentHabitStreak = 1;
                        }
                        lastDate = date;
                    } else {
                        currentHabitStreak = 0; // Break streak if not completed
                        lastDate = null;
                    }
                }
                habitCompletionCounts[habitName].streak = currentHabitStreak;
            }

            habitStatsContainer.innerHTML = '';
            if (Object.keys(habitCompletionCounts).length === 0) {
                habitStatsContainer.innerHTML = '<p class="text-center text-gray-400 py-4">Chưa có dữ liệu thống kê thói quen.</p>';
            } else {
                for (const name in habitCompletionCounts) {
                    const stats = habitCompletionCounts[name];
                    const completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                    const item = document.createElement('div');
                    item.className = `p-3 rounded-lg bg-gray-800/50 border border-gray-700`;
                    item.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-white">${name}</h4>
                            <span class="text-sm text-gray-400">${stats.completed}/${stats.total} (${completionRate}%)</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-1">
                            <div class="bg-gradient-to-r from-teal-400 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${completionRate}%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Chuỗi: <span class="font-bold text-teal-300">${stats.streak} ngày</span></p>
                    `;
                    habitStatsContainer.appendChild(item);
                }
            }
            lucide.createIcons();
        }


        // Render entire app (main tabs and current sub-tab content)
        function renderApp() {
            document.getElementById('loading-overlay').style.display = isLoading ? 'flex' : 'none';
            renderWorkoutSubTabs(); // Render workout sub-tabs or hide them

            // Update bottom nav bar active state
            document.querySelectorAll('.bottom-nav-item').forEach(btn => {
                if (btn.id === `nav-${currentMainTab}-btn`) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (currentMainTab === 'workout') {
                if (currentWorkoutSubTab === 'today') renderTodayWorkoutTab();
                else if (currentWorkoutSubTab === 'my-workouts') renderMyWorkoutsTab();
                else renderStatsWorkoutTab();
            } else if (currentMainTab === 'habit') {
                renderHabitTab();
            }
            lucide.createIcons(); // Ensure icons are rendered after each DOM update
        }

        // Toggle workout completion status
        async function toggleWorkout(objectId) {
            const idx = workouts.findIndex(w => w.objectId === objectId);
            if (idx > -1) {
                const newStatus = !workouts[idx].completed; 
                try { 
                    await Backendless.Data.of('DailyWorkouts').save({ objectId: objectId, completed: newStatus }); // Save to Backendless
                    workouts[idx].completed = newStatus; // Update locally
                    updateCurrentDayWeeklyStat(); // Update stats
                    renderApp(); // Re-render
                }
                catch (e) { 
                    console.error("Error toggling workout:", e); 
                    showMessage("Error updating workout status.", "error"); 
                }
            }
        }

        // Add new workout from "Today" tab
        async function addNewWorkoutFromTodayTab() {
            const name = document.getElementById('new-workout-name-today').value.trim();
            const setsStr = document.getElementById('new-workout-sets-today').value.trim();
            const repsStr = document.getElementById('new-workout-reps-today').value.trim();
            const weightStr = document.getElementById('new-workout-weight-today').value.trim();
            const img = document.getElementById('new-workout-image-url-today').value.trim();

            const sets = parseInt(setsStr);
            const reps = parseInt(repsStr);
            let weight = parseFloat(weightStr);
            if (isNaN(weight) || weight < 0) weight = 0; // Default weight to 0 if invalid

            if (!name || isNaN(sets) || isNaN(reps) || sets <= 0 || reps <= 0) { 
                showMessage("Name, Sets, Reps are invalid!", "error"); return; 
            }
            
            let masterId;
            // Check if this workout already exists in the master list (AllWorkouts) (based on name)
            let existingMaster = allWorkouts.find(w => w.name === name); // Simple name match
            
            if (existingMaster) {
                masterId = existingMaster.objectId; // Use existing masterId
            } else {
                // If not, create new in AllWorkouts
                try { 
                    const masterPayload = { name, num_sets: sets, num_reps: reps, default_weight_kg: weight, image_url: img };
                    // if(userId) masterPayload.ownerId = userId; // If AllWorkouts are user-specific
                    const savedMaster = await Backendless.Data.of('AllWorkouts').save(masterPayload); 
                    masterId = savedMaster.objectId; 
                    allWorkouts.push(savedMaster); // Add to local list
                }
                catch(e) { console.error("Error adding master workout:", e); showMessage("Error adding master workout.", "error"); return; }
            }

            // Create record for DailyWorkouts
            const dailyPayload = { 
                master_id: masterId, 
                ownerId: userId, 
                name, 
                num_sets: sets, 
                num_reps: reps, 
                weight_kg: weight,
                volume: sets * reps, // Calculate volume
                image_url: img || (existingMaster ? existingMaster.image_url : ''), // Prefer new image, otherwise use image from master
                completed: false, 
                workout_date: getTodayDateString() 
            };

            try {
                const newDaily = await Backendless.Data.of('DailyWorkouts').save(dailyPayload); 
                workouts.push(newDaily); 
                totalWorkouts++; 
                updateCurrentDayWeeklyStat(); 
                showMessage("Workout added for today!", "success");
                // Clear input fields
                ['new-workout-name-today', 'new-workout-sets-today', 'new-workout-reps-today', 'new-workout-weight-today', 'new-workout-image-url-today'].forEach(id => document.getElementById(id).value = '');
                showAddWorkoutFormToday = false; // Hide form
                renderApp();
            } catch (e) { console.error("Error adding daily workout:", e); showMessage("Error adding workout for today.", "error"); }
        }

        // Add new workout from "My Workouts" tab (add to master list AllWorkouts)
        async function addNewWorkoutFromMyWorkoutsTab() {
            const name = document.getElementById('new-workout-name-my-workouts').value.trim();
            const setsStr = document.getElementById('new-workout-sets-my-workouts').value.trim();
            const repsStr = document.getElementById('new-workout-reps-my-workouts').value.trim();
            const defaultWeightStr = document.getElementById('new-workout-default-weight-my-workouts').value.trim();
            const img = document.getElementById('new-workout-image-url-my-workouts').value.trim();

            const sets = parseInt(setsStr);
            const reps = parseInt(repsStr);
            let defaultWeight = parseFloat(defaultWeightStr);
            if (isNaN(defaultWeight) || defaultWeight < 0) defaultWeight = 0;

            if (!name || isNaN(sets) || isNaN(reps) || sets <= 0 || reps <= 0) { 
                showMessage("Name, Sets, Reps are invalid!", "error"); return; 
            }
            // Check for duplicates in master list
            if (allWorkouts.some(w => w.name === name && w.num_sets === sets && w.num_reps === reps && (w.default_weight_kg || 0) === defaultWeight)) { 
                showMessage("This workout already exists in the master list!", "info"); return; 
            }
            try {
                const masterPayload = { name, num_sets: sets, num_reps: reps, default_weight_kg: defaultWeight, image_url: img };
                // if(userId) masterPayload.ownerId = userId; // If AllWorkouts are user-specific
                const saved = await Backendless.Data.of('AllWorkouts').save(masterPayload); 
                allWorkouts.push(saved);
                allWorkouts.sort((a,b) => (a.name || "").localeCompare(b.name || "")); // Re-sort
                showMessage("Added to master list!", "success");
                // Clear input fields
                ['new-workout-name-my-workouts', 'new-workout-sets-my-workouts', 'new-workout-reps-my-workouts', 'new-workout-default-weight-my-workouts', 'new-workout-image-url-my-workouts'].forEach(id => document.getElementById(id).value = '');
                showAddWorkoutFormMyWorkouts = false; // Hide form
                renderApp();
            } catch (e) { console.error("Error adding master workout:", e); showMessage("Error adding workout to master list.", "error"); }
        }

        // Add selected workout from master list to today's list
        async function addSelectedWorkoutToToday(masterWorkoutObjectId) {
            const workoutToAdd = allWorkouts.find(w => w.objectId === masterWorkoutObjectId);
            if (workoutToAdd) {
                // Check if this workout (based on master_id) is already in today's list
                if (!workouts.some(w => w.master_id === masterWorkoutObjectId && w.workout_date === getTodayDateString())) {
                    const dailyPayload = { 
                        master_id: masterWorkoutObjectId, 
                        ownerId: userId, 
                        name: workoutToAdd.name, 
                        num_sets: workoutToAdd.num_sets, 
                        num_reps: workoutToAdd.num_reps, 
                        weight_kg: workoutToAdd.default_weight_kg != null ? workoutToAdd.default_weight_kg : 0, // Get default weight
                        volume: (workoutToAdd.num_sets || 0) * (workoutToAdd.num_reps || 0), 
                        image_url: workoutToAdd.image_url || '', 
                        completed: false, 
                        workout_date: getTodayDateString() 
                    };
                    try { 
                        const newDaily = await Backendless.Data.of('DailyWorkouts').save(dailyPayload); 
                        workouts.push(newDaily); 
                        totalWorkouts++; 
                        updateCurrentDayWeeklyStat(); 
                        showMessage("Added to today's workouts!", "success"); 
                        renderApp(); 
                    }
                    catch (e) { console.error("Error adding selected workout to today:", e); showMessage("Error adding workout to today.", "error"); }
                } else showMessage("This workout is already in today's list!", "info");
            }
        }

        // Remove workout from today's list
        async function removeWorkout(objectId) { 
            try { 
                await Backendless.Data.of('DailyWorkouts').remove({ objectId }); 
                workouts = workouts.filter(w => w.objectId !== objectId); 
                updateCurrentDayWeeklyStat(); 
                showMessage("Workout removed from today.", "success"); 
                renderApp(); 
            }
            catch (e) { console.error("Error deleting daily workout:", e); showMessage("Error deleting workout.", "error"); }
        }
        // Remove workout from master list (AllWorkouts)
        async function removeMasterWorkout(objectId) { 
            // Use a custom confirmation dialog instead of window.confirm
            // Example: display a confirmation modal
            // For now, for simplicity, skip confirmation or you can add it yourself
            // if (!confirm("Are you sure you want to delete this workout from the master list?")) {
            //     return;
            // }
            // Instead of confirm, you can display a custom modal here
            // and only proceed with deletion if the user confirms in that modal.
            // Example:
            // showCustomConfirm("Are you sure you want to delete this workout from the master list?", async () => {
            //    // deletion logic here
            // });
            // return; // Wait for confirmation from modal
            
            // Temporarily still using old method, but custom modal is recommended
             if (!confirm("Are you sure you want to delete this workout from the master list? This action will also delete this workout from your workout history (if any).")) {
                 return;
             }


            try { 
                await Backendless.Data.of('AllWorkouts').remove({ objectId }); 
                allWorkouts = allWorkouts.filter(w => w.objectId !== objectId); 
                // Optional: Remove this workout from today's list if present
                const wasInToday = workouts.some(w => w.master_id === objectId);
                workouts = workouts.filter(w => w.master_id !== objectId);
                if (wasInToday) updateCurrentDayWeeklyStat();

                // Optional: Delete from history (DailyWorkouts) for all days
                // const relatedDailyQuery = Backendless.DataQueryBuilder.create().setWhereClause(`master_id = '${objectId}' AND ownerId = '${userId}'`);
                // await Backendless.Data.of('DailyWorkouts').bulkDelete(relatedDailyQuery);
                // Need to reload weeklyStats if you want it to reflect deletion from history

                showMessage("Workout removed from master list.", "success"); 
                renderApp(); 
            }
            catch (e) { console.error("Error deleting master workout:", e); showMessage("Error deleting workout from master list.", "error"); }
        }

        // Toggle habit completion status
        async function toggleHabit(objectId) {
            const idx = habits.findIndex(h => h.objectId === objectId);
            if (idx > -1) {
                const newStatus = !habits[idx].completed; 
                try { 
                    await Backendless.Data.of('DailyHabits').save({ objectId: objectId, completed: newStatus }); // Save to Backendless
                    habits[idx].completed = newStatus; // Update locally
                    // No specific daily stats for habits, but you might want to trigger a re-render of habit stats
                    renderApp(); // Re-render
                }
                catch (e) { 
                    console.error("Error toggling habit:", e); 
                    showMessage("Error updating habit status.", "error"); 
                }
            }
        }

        // Add new habit
        async function addNewHabit() {
            const name = document.getElementById('new-habit-name').value.trim();
            if (!name) { showMessage("Please enter a habit name!", "error"); return; }

            let masterId;
            // Check if this habit already exists in the master list (AllHabits)
            let existingMaster = allHabits.find(h => h.name === name);
            
            if (existingMaster) {
                masterId = existingMaster.objectId; // Use existing masterId
            } else {
                // If not, create new in AllHabits
                try { 
                    const masterPayload = { name };
                    const savedMaster = await Backendless.Data.of('AllHabits').save(masterPayload); 
                    masterId = savedMaster.objectId; 
                    allHabits.push(savedMaster); // Add to local list
                }
                catch(e) { console.error("Error adding master habit:", e); showMessage("Error adding master habit.", "error"); return; }
            }

            // Check if this habit is already in today's list
            if (habits.some(h => h.master_id === masterId && h.habit_date === getTodayDateString())) {
                showMessage("This habit is already in today's list!", "info");
                return;
            }

            // Create record for DailyHabits
            const dailyPayload = { 
                master_id: masterId, 
                ownerId: userId, 
                name, 
                completed: false, 
                habit_date: getTodayDateString() 
            };

            try {
                const newDaily = await Backendless.Data.of('DailyHabits').save(dailyPayload); 
                habits.push(newDaily); 
                showMessage("Habit added for today!", "success");
                document.getElementById('new-habit-name').value = ''; // Clear input
                showAddHabitForm = false; // Hide form
                renderApp();
            } catch (e) { console.error("Error adding daily habit:", e); showMessage("Error adding habit for today.", "error"); }
        }

        // Remove habit from today's list and master list
        async function removeHabit(objectId) { 
            // Find the habit to get its master_id
            const habitToRemove = habits.find(h => h.objectId === objectId);
            if (!habitToRemove) return;

            // Confirm deletion
            if (!confirm("Are you sure you want to delete this habit? This will remove it from today's list and the master list.")) {
                return;
            }

            try { 
                // Remove from DailyHabits
                await Backendless.Data.of('DailyHabits').remove({ objectId }); 
                habits = habits.filter(h => h.objectId !== objectId); 

                // Remove from AllHabits (master list)
                await Backendless.Data.of('AllHabits').remove({ objectId: habitToRemove.master_id });
                allHabits = allHabits.filter(h => h.objectId !== habitToRemove.master_id);

                showMessage("Habit removed.", "success"); 
                renderApp(); 
            }
            catch (e) { console.error("Error deleting habit:", e); showMessage("Error deleting habit.", "error"); }
        }


        // Handle sign up
        async function handleSignUp() {
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-password').value;
            if (!email || !pass) { showMessage("Please enter email and password.", "error"); return; }
            const user = new Backendless.User(); user.email = email; user.password = pass;
            try { 
                await Backendless.UserService.register(user); 
                showMessage("Registration successful! Please check your email for verification (if configured). Then log in.", "success"); 
            }
            catch (e) { showMessage(`Registration failed: ${e.message}`, "error"); console.error("Registration Error:", e); }
        }
        // Handle sign in
        async function handleSignIn() {
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-password').value;
            if (!email || !pass) { showMessage("Please enter email and password.", "error"); return; }
            try { 
                const user = await Backendless.UserService.login(email, pass, true); // true to remember login
                userId = user.objectId;
                showMessage("Login successful!", "success");
                document.getElementById('auth-container').style.display = 'none'; 
                document.getElementById('app-container').style.display = 'block';
                currentDayString = getTodayDateString(); // Reset current day after login
                await loadDataFromBackendless(); // Load data for new user
                initializeAppAndHandleDailyRollover(); // Handle daily rollover
                renderApp();
            } catch (e) { showMessage(`Login failed: ${e.message}`, "error"); console.error("Login Error:", e); }
        }

        // Event when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            updateLiveDateTime(); setInterval(updateLiveDateTime, 1000 * 30); // Update clock every 30 seconds
            try {
                isLoading = true; 
                document.getElementById('loading-overlay').style.display = 'flex';
                lucide.createIcons(); // Initial icon creation

                const currentUser = await Backendless.UserService.getCurrentUser(); // Check if user is logged in
                if (currentUser) {
                    userId = currentUser.objectId;
                    document.getElementById('auth-container').style.display = 'none'; // Hide login/signup form
                    document.getElementById('app-container').style.display = 'block'; // Show app
                    currentDayString = getTodayDateString(); 
                    await loadDataFromBackendless(); 
                    initializeAppAndHandleDailyRollover(); 
                    renderApp();
                } else {
                    // User not logged in
                    userId = null; 
                    document.getElementById('auth-container').style.display = 'flex'; // Show login/signup form
                    document.getElementById('app-container').style.display = 'none'; // Hide app
                    isLoading = false; 
                    document.getElementById('loading-overlay').style.display = 'none'; // Hide loading
                    lucide.createIcons(); // Create icons for login form
                }
            } catch (e) {
                // Handle error if current user cannot be checked (e.g., connection lost)
                console.error("Error checking login status:", e); 
                userId = null;
                document.getElementById('auth-container').style.display = 'flex'; 
                document.getElementById('app-container').style.display = 'none';
                isLoading = false; 
                document.getElementById('loading-overlay').style.display = 'none'; 
                lucide.createIcons();
            } finally {
                // Ensure loading overlay is always hidden if not loading
                if (!isLoading && document.getElementById('loading-overlay').style.display !== 'none') {
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            }

            // Attach event listeners for signup, signin buttons
            document.getElementById('signup-btn').addEventListener('click', handleSignUp);
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);
            
            // Attach event listeners for workout sub-tabs
            ['today', 'my-workouts', 'stats'].forEach(tab => {
                const btn = document.getElementById(`${tab}-tab-btn`);
                if(btn) btn.addEventListener('click', () => {
                    currentWorkoutSubTab = tab; 
                    showAddWorkoutFormToday = false; // Reset form state when changing tabs
                    showAddWorkoutFormMyWorkouts = false; 
                    renderApp();
                });
            });

            // Attach event listeners for main navigation tabs
            document.getElementById('nav-workout-btn').addEventListener('click', () => {
                currentMainTab = 'workout';
                renderApp();
            });
            document.getElementById('nav-habit-btn').addEventListener('click', () => {
                currentMainTab = 'habit';
                renderApp();
            });

            // Attach event listener for closing workout detail modal
            const closeModalButton = document.getElementById('close-workout-detail-modal');
            if(closeModalButton) closeModalButton.addEventListener('click', closeWorkoutDetailsModal);
            
            // Attach event listener for closing modal when clicking outside (on overlay)
            const modalOverlay = document.getElementById('workout-detail-modal');
            if(modalOverlay) modalOverlay.addEventListener('click', (e) => { 
                if (e.target === e.currentTarget) closeWorkoutDetailsModal(); // Only close if clicking directly on overlay
            });
            
            // If both app and auth are hidden (rare case), still create icons
            if(document.getElementById('app-container').style.display === 'none' && document.getElementById('auth-container').style.display === 'none'){
                 lucide.createIcons();
            }
        });
        // Re-create icons on window resize (to ensure correct display)
        window.addEventListener('resize', () => { lucide.createIcons(); }); 
    </script>
</body>
</html>
