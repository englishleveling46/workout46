<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/backendless@7.4.6/dist/backendless.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for Lucide icons to ensure they are rendered */
        [data-lucide] {
            display: inline-block;
        }
        /* Style for the live clock to ensure proper alignment if needed */
        #current-date {
            line-height: 1.4; /* Adjust line height for two lines of text */
        }
        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1a1a1a; /* Slightly lighter dark for modal content */
            border-radius: 1rem;
            padding: 1.5rem; /* 24px */
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white font-inter">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4" style="display: none;">
        <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-6 border border-white/10 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center mb-6 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                Fitness Tracker
            </h2>
            <div class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="auth-email" placeholder="email@example.com" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-300 mb-1">Mật khẩu</label>
                    <input type="password" id="auth-password" placeholder="Mật khẩu" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                </div>
                <button id="signup-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold">
                    Đăng ký
                </button>
                <button id="signin-btn" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold">
                    Đăng nhập
                </button>
            </div>
            <p class="text-center text-gray-400 text-xs mt-4">
                Sử dụng email và mật khẩu để đăng nhập hoặc đăng ký.
            </p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <div class="bg-black/20 backdrop-blur-lg border-b border-white/10 sticky top-0 z-50">
            <div class="px-4 py-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl">
                            <i data-lucide="flame" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                Fitness Tracker
                            </h1>
                            <p class="text-xs text-gray-400">Theo dõi tập luyện hàng ngày</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="current-date" class="text-lg font-bold"></div>
                        <div class="text-xs text-gray-400">Thời gian hiện tại</div>
                    </div>
                </div>

                <div class="flex bg-gray-800/50 rounded-xl p-1">
                    <button id="today-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        Hôm nay
                    </button>
                    <button id="my-workouts-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        Bài tập của tôi
                    </button>
                    <button id="stats-tab-btn" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all">
                        Thống kê
                    </button>
                </div>
            </div>
        </div>

        <div id="main-content" class="px-4 py-4 pb-20">
            </div>

        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
            <div class="text-center">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-purple-400 mb-4"></i>
                <p class="text-lg font-medium">Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>

    <div id="message-area" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 p-3 rounded-lg text-white text-center shadow-lg transition-all duration-300 transform -translate-y-full opacity-0" style="min-width: 250px;"></div>

    <div id="workout-detail-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-workout-name" class="text-xl font-bold text-white"></h3>
                <button id="close-workout-detail-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-workout-image-container" class="mb-4 text-center">
                </div>

            <div id="modal-sets-reps-editor" class="bg-gray-800/50 p-3 rounded-lg mb-4" style="display: none;">
                <h4 class="text-md font-semibold mb-3 text-center text-purple-300">Chỉnh sửa Hôm nay</h4>

                <div class="flex items-center justify-between mb-2.5">
                    <label for="modal-sets-input" class="text-sm font-medium text-gray-300">Sets</label>
                    <div class="flex items-center space-x-1.5">
                        <button id="sets-decrement-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                        </button>
                        <input type="number" id="modal-sets-input" class="w-14 bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white text-center text-sm focus:outline-none focus:border-purple-500" min="1" />
                        <button id="sets-increment-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-2.5">
                    <label for="modal-reps-input" class="text-sm font-medium text-gray-300">Reps</label>
                    <div class="flex items-center space-x-1.5">
                        <button id="reps-decrement-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                        </button>
                        <input type="number" id="modal-reps-input" class="w-14 bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white text-center text-sm focus:outline-none focus:border-purple-500" min="1" />
                        <button id="reps-increment-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-3">
                    <label for="modal-weight-input" class="text-sm font-medium text-gray-300">Tạ (kg)</label>
                    <div class="flex items-center space-x-1.5">
                        <button id="weight-decrement-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="minus" class="w-3.5 h-3.5"></i>
                        </button>
                        <input type="number" id="modal-weight-input" class="w-20 bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white text-center text-sm focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                        <button id="weight-increment-btn" class="bg-gray-700 hover:bg-gray-600 p-1.5 rounded-md transition-colors">
                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>

                <button id="save-workout-details-btn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-4 py-2 rounded-lg transition-all duration-200 text-sm font-semibold mt-3">
                    Lưu thay đổi
                </button>
            </div>
            
            <div id="modal-workout-history-section" style="display: block;">
                <h4 class="text-lg font-semibold mb-2">Lịch sử 5 ngày gần nhất:</h4>
                <div id="modal-workout-history" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Biến trạng thái toàn cục
        let workouts = []; // Bài tập hàng ngày
        let allWorkouts = []; // Danh sách tất cả bài tập (master list)
        let streak = 0; // Chuỗi ngày tập luyện liên tiếp
        let totalWorkouts = 0; // Tổng số bài tập đã hoàn thành
        let weeklyStats = []; // Thống kê hàng tuần
        let currentTab = 'today'; // Tab hiện tại đang được chọn
        let showAddWorkoutFormToday = false; // Hiển thị form thêm bài tập ở tab "Hôm nay"
        let showAddWorkoutFormMyWorkouts = false; // Hiển thị form thêm bài tập ở tab "Bài tập của tôi"
        let isLoading = true; // Trạng thái tải dữ liệu

        let currentDayString = new Date().toISOString().split('T')[0]; // Ngày hiện tại dạng YYYY-MM-DD
        let streakLastAchievedDate = null; // Ngày cuối cùng đạt được streak

        const MAX_WEEKLY_STATS_DAYS = 30; // Số ngày tối đa lưu trữ trong thống kê tuần
        const MODAL_WEIGHT_ADJUST_STEP = 2.5; // Bước nhảy khi điều chỉnh tạ trong modal


        // Khóa Backendless - THAY THẾ BẰNG KHÓA CỦA BẠN
        const BACKENDLESS_APP_ID = 'E1DD6501-EFB3-4E39-BED7-597DE3133D98'; 
        const BACKENDLESS_JS_API_KEY = '8983A173-7621-4F13-924C-3C17494E74EA'; 

        Backendless.initApp(BACKENDLESS_APP_ID, BACKENDLESS_JS_API_KEY);

        let userId = null; // ID của người dùng sau khi đăng nhập

        // Lấy ngày hiện tại dưới dạng chuỗi YYYY-MM-DD
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        // Hiển thị thông báo
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = message;
            messageArea.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 z-50 p-3 rounded-lg text-white text-center shadow-lg transition-all duration-300 transform opacity-100 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500' // Mặc định là màu xanh dương cho 'info'
            }`;
            messageArea.style.transform = 'translateY(0)';
            messageArea.style.opacity = '1';

            setTimeout(() => {
                messageArea.style.transform = 'translateY(-100%)';
                messageArea.style.opacity = '0';
            }, 3000); // Thông báo tự biến mất sau 3 giây
        }

        // Cập nhật đồng hồ và ngày tháng trực tiếp
        function updateLiveDateTime() {
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                const dateString = now.toLocaleDateString('vi-VN', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit'
                });
                currentDateElement.innerHTML = `<span class="text-base">${timeString}</span><br>${dateString}`;
            }
        }

        // Tải dữ liệu từ Backendless
        async function loadDataFromBackendless() {
            isLoading = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            // Đảm bảo icon loader được render nếu chưa có
            if (document.querySelector('#loading-overlay [data-lucide="loader-2"]')) { 
                 lucide.createIcons(); // Tạo lại icon nếu cần
            }

            if (!userId) {
                console.warn("User not authenticated. Cannot load data from Backendless.");
                isLoading = false;
                document.getElementById('loading-overlay').style.display = 'none';
                return;
            }

            try {
                // Tải bài tập hàng ngày của người dùng cho ngày hôm nay
                const dailyWorkoutsQueryBuilder = Backendless.DataQueryBuilder.create()
                    .setWhereClause(`ownerId = '${userId}' AND workout_date = '${getTodayDateString()}'`);
                const dailyWorkoutsData = await Backendless.Data.of('DailyWorkouts').find(dailyWorkoutsQueryBuilder);
                workouts = dailyWorkoutsData || [];

                // Tải danh sách tất cả bài tập (master list)
                const allWorkoutsQueryBuilder = Backendless.DataQueryBuilder.create(); 
                // Nếu AllWorkouts là của riêng người dùng, thêm: .setWhereClause(`ownerId = '${userId}'`) 
                // Ví dụ này giả định AllWorkouts là chung, hoặc bạn sẽ thêm ownerId khi tạo chúng nếu cần.
                const allWorkoutsData = await Backendless.Data.of('AllWorkouts').find(allWorkoutsQueryBuilder);
                allWorkouts = allWorkoutsData || [];

                // Tải thống kê người dùng
                const userStatsQueryBuilder = Backendless.DataQueryBuilder.create()
                    .setWhereClause(`ownerId = '${userId}'`);
                const userStatsData = await Backendless.Data.of('UserStats').find(userStatsQueryBuilder);

                if (userStatsData && userStatsData.length > 0) {
                    const userStats = userStatsData[0];
                    streak = userStats.streak || 0;
                    totalWorkouts = userStats.total_workouts || 0;
                    weeklyStats = userStats.weekly_stats ? JSON.parse(userStats.weekly_stats) : [];
                    streakLastAchievedDate = userStats.streak_last_achieved_date;
                } else {
                    // Nếu không có thống kê, tạo mới
                    const newUserStats = { ownerId: userId, streak: 0, total_workouts: 0, weekly_stats: JSON.stringify([]) };
                    await Backendless.Data.of('UserStats').save(newUserStats);
                }
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ Backendless:", error);
                showMessage(`Lỗi khi tải dữ liệu: ${error.message}. Vui lòng thử lại.`, "error");
                // Reset về trạng thái mặc định nếu có lỗi
                workouts = []; allWorkouts = []; streak = 0; totalWorkouts = 0; weeklyStats = []; streakLastAchievedDate = null;
            } finally {
                isLoading = false;
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // Lưu dữ liệu thống kê người dùng lên Backendless
        async function saveDataToBackendless() { // Hàm này cụ thể lưu UserStats
            if (!userId) {
                showMessage("Lỗi: Bạn cần đăng nhập để lưu dữ liệu.", "error");
                return;
            }
            const saveButton = document.getElementById('save-data-to-sheet-btn'); // Giả sử có nút này
            const originalButtonHtml = saveButton ? saveButton.innerHTML : '';
            if (saveButton) {
                saveButton.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> <span class="hidden sm:inline">Đang lưu...</span>';
                saveButton.disabled = true;
                lucide.createIcons();
            }

            try {
                const userStatsQueryBuilder = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}'`);
                const existingUserStats = await Backendless.Data.of('UserStats').find(userStatsQueryBuilder);
                let userStatsToSave = {
                    streak: streak, total_workouts: totalWorkouts,
                    weekly_stats: JSON.stringify(weeklyStats), // Chuyển mảng thành chuỗi JSON
                    streak_last_achieved_date: streakLastAchievedDate
                };
                if (existingUserStats && existingUserStats.length > 0) {
                    userStatsToSave.objectId = existingUserStats[0].objectId; // Cập nhật bản ghi hiện có
                } else {
                    userStatsToSave.ownerId = userId; // Tạo bản ghi mới nếu chưa có
                }
                await Backendless.Data.of('UserStats').save(userStatsToSave);
                if (saveButton) showMessage("Dữ liệu thống kê đã được lưu!", "success");
            } catch (error) {
                console.error("Lỗi khi gửi UserStats đến Backendless:", error);
                showMessage(`Lỗi khi lưu dữ liệu thống kê: ${error.message}.`, "error");
            } finally {
                if (saveButton) {
                    saveButton.innerHTML = originalButtonHtml || '<i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">Lưu dữ liệu</span>'; // Khôi phục nút
                    saveButton.disabled = false;
                    lucide.createIcons();
                }
            }
        }
        
        // Khởi tạo ứng dụng và xử lý khi qua ngày mới
        function initializeAppAndHandleDailyRollover() {
            const todayStr = getTodayDateString();
            if (currentDayString !== todayStr) { // Nếu đã qua ngày mới
                // Tính toán số liệu của ngày cũ (currentDayString)
                const pastDayActualCompletions = workouts.filter(w => w.completed).length;
                const pastDayTotalTasks = workouts.length;

                // Tìm xem ngày cũ đã có trong weeklyStats chưa
                const lastDayStatIndex = weeklyStats.findIndex(s => s.date === currentDayString);

                // Nếu ngày cũ là ngày hôm qua của ngày hiện tại (todayStr)
                if (lastDayStatIndex > -1 && new Date(currentDayString).toDateString() === new Date(new Date(todayStr).getTime() - 86400000).toDateString()) {
                    // Cập nhật số liệu cho ngày hôm qua nếu nó đã tồn tại
                    weeklyStats[lastDayStatIndex].total = pastDayTotalTasks;
                    weeklyStats[lastDayStatIndex].completed = pastDayActualCompletions;
                    weeklyStats[lastDayStatIndex].exercises = workouts.map(w => w.name); // Lưu tên các bài tập đã làm
                } else if (pastDayTotalTasks > 0 || pastDayActualCompletions > 0) { // Nếu không phải hôm qua, nhưng có dữ liệu, thì thêm mới
                     weeklyStats.push({
                        date: currentDayString, total: pastDayTotalTasks,
                        completed: pastDayActualCompletions, exercises: workouts.map(w => w.name)
                    });
                }

                // Sắp xếp lại weeklyStats theo ngày giảm dần và giới hạn số ngày
                weeklyStats.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (weeklyStats.length > MAX_WEEKLY_STATS_DAYS) weeklyStats = weeklyStats.slice(0, MAX_WEEKLY_STATS_DAYS);

                // Cập nhật streak
                if (pastDayTotalTasks > 0 && pastDayActualCompletions === pastDayTotalTasks) { // Hoàn thành tất cả bài tập ngày cũ
                    if (streakLastAchievedDate) {
                        const expectedPrevStreakDate = new Date(new Date(currentDayString).getTime() - 86400000).toISOString().split('T')[0]; // Ngày streak dự kiến trước đó
                        if (streakLastAchievedDate === expectedPrevStreakDate) streak++; else streak = 1; // Reset streak nếu không liên tục
                    } else streak = 1; // Bắt đầu streak mới
                    streakLastAchievedDate = currentDayString; // Lưu ngày đạt streak
                } else {
                    // Nếu ngày cũ là hôm qua và không hoàn thành hết, reset streak
                    const yesterdayStr = new Date(new Date(todayStr).getTime() - 86400000).toISOString().split('T')[0];
                    if (currentDayString === yesterdayStr && pastDayTotalTasks > 0) { // Chỉ reset nếu có bài tập vào ngày hôm qua
                        streak = 0; 
                        streakLastAchievedDate = null; // Reset ngày streak
                    }
                    // Nếu không phải hôm qua, không làm gì với streak (tránh reset oan)
                }
                workouts = []; // Reset bài tập cho ngày mới
                currentDayString = todayStr; // Cập nhật ngày hiện tại
            }
            updateCurrentDayWeeklyStat(); // Cập nhật thống kê cho ngày hiện tại (có thể là ngày mới hoặc vẫn là ngày cũ nếu chưa qua 0h)
        }

        // Cập nhật thống kê cho ngày hiện tại trong weeklyStats
        function updateCurrentDayWeeklyStat() {
            if (!currentDayString) return; // Chưa có ngày hiện tại
            const todayActualCompletions = workouts.filter(w => w.completed).length;
            const todayTotalTasks = workouts.length;
            const todayStatPayload = {
                date: currentDayString, total: todayTotalTasks,
                completed: todayActualCompletions, exercises: workouts.map(w => w.name)
            };
            const existingStatIndex = weeklyStats.findIndex(s => s.date === currentDayString);
            if (existingStatIndex > -1) weeklyStats[existingStatIndex] = todayStatPayload; // Cập nhật nếu đã có
            else weeklyStats.push(todayStatPayload); // Thêm mới nếu chưa có
            
            weeklyStats.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sắp xếp lại
            if (weeklyStats.length > MAX_WEEKLY_STATS_DAYS) weeklyStats = weeklyStats.slice(0, MAX_WEEKLY_STATS_DAYS); // Giới hạn số ngày

            saveDataToBackendless(); // Lưu lại thống kê người dùng
        }

        // Các hàm tiện ích lấy thông tin thống kê
        function getCompletedCount() { return workouts.filter(w => w.completed).length; }
        function getCompletionRate() { const c = getCompletedCount(); return workouts.length > 0 ? Math.round((c / workouts.length) * 100) : 0; }
        function formatDate(dateString) { // Định dạng ngày tháng (VD: T2, 28/05)
            const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() + userTimezoneOffset); // Điều chỉnh múi giờ
            return localDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', weekday: 'short' });
        }
        function getWeeklyAverage() { // Tỷ lệ hoàn thành trung bình 7 ngày gần nhất
            if (weeklyStats.length === 0) return 0; const relevantStats = weeklyStats.slice(0, 7);
            const totalCompleted = relevantStats.reduce((sum, day) => sum + day.completed, 0);
            const totalPossible = relevantStats.reduce((sum, day) => sum + day.total, 0);
            return totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
        }
        function getMostActiveDay() { // Ngày hoàn thành nhiều bài tập nhất
            if (weeklyStats.length === 0) return 'Chưa có'; let maxCompleted = -1; let mostActiveDayData = null;
            for (const day of weeklyStats) { if (day.completed > maxCompleted) { maxCompleted = day.completed; mostActiveDayData = day; } }
            return mostActiveDayData && maxCompleted > 0 ? formatDate(mostActiveDayData.date) : 'Chưa có';
        }
        function getCurrentWeekTotalCompleted() { const r = weeklyStats.slice(0, 7); return r.reduce((s, d) => s + d.completed, 0); }

        // Render header (tabs)
        function renderHeader() {
            const todayTabBtn = document.getElementById('today-tab-btn');
            const myWorkoutsTabBtn = document.getElementById('my-workouts-tab-btn');
            const statsTabBtn = document.getElementById('stats-tab-btn');
            const baseClass = "flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all";
            const activeClass = "bg-gradient-to-r from-purple-500 to-pink-500 text-white";
            const inactiveClass = "text-gray-400 hover:text-white";
            todayTabBtn.className = `${baseClass} ${currentTab === 'today' ? activeClass : inactiveClass}`;
            myWorkoutsTabBtn.className = `${baseClass} ${currentTab === 'my-workouts' ? activeClass : inactiveClass}`;
            statsTabBtn.className = `${baseClass} ${currentTab === 'stats' ? activeClass : inactiveClass}`;
        }

        // Render nội dung tab "Hôm nay"
        function renderTodayTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-green-500/20 to-green-600/20 backdrop-blur-lg rounded-xl p-3 border border-green-500/30 text-center">
                        <i data-lucide="check-circle-2" class="w-6 h-6 text-green-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${getCompletedCount()}</p><p class="text-xs text-green-300">Hoàn thành</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500/20 to-red-500/20 backdrop-blur-lg rounded-xl p-3 border border-orange-500/30 text-center">
                        <i data-lucide="flame" class="w-6 h-6 text-orange-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${streak}</p><p class="text-xs text-orange-300">Ngày liên tiếp</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500/20 to-purple-500/20 backdrop-blur-lg rounded-xl p-3 border border-blue-500/30 text-center">
                        <i data-lucide="trophy" class="w-6 h-6 text-blue-400 mx-auto mb-1"></i>
                        <p class="text-xl font-bold">${getCompletionRate()}%</p><p class="text-xs text-blue-300">Tiến độ</p>
                    </div>
                </div>
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 mb-6 border border-white/10">
                    <div class="flex items-center justify-between mb-3"><h3 class="font-semibold">Tiến độ hôm nay</h3><span class="text-sm text-gray-400">${getCompletedCount()}/${workouts.length}</span></div>
                    <div class="w-full bg-gray-700 rounded-full h-3 mb-2"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: ${getCompletionRate()}%"></div></div>
                    <p class="text-xs text-gray-400 text-center">${getCompletionRate() === 100 && workouts.length > 0 ? '🎉 Xuất sắc! Hoàn thành tất cả bài tập!' : workouts.length > 0 ? `Còn ${workouts.length - getCompletedCount()} bài tập nữa` : 'Thêm bài tập cho hôm nay!'}</p>
                </div>
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden mb-6">
                    <div class="p-4 border-b border-white/10">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-bold">Bài tập hôm nay</h2>
                            <div class="flex space-x-2">
                                <button id="save-data-to-sheet-btn" class="flex items-center space-x-1 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                                    <i data-lucide="save" class="w-4 h-4"></i><span class="hidden sm:inline">Lưu dữ liệu</span>
                                </button>
                                <button id="add-workout-today-btn" class="flex items-center space-x-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                                    <i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Thêm</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="add-new-workout-form-today" class="p-4 bg-gray-800/50 border-b border-white/10" style="display: ${showAddWorkoutFormToday ? 'block' : 'none'};">
                        <div class="flex justify-end mb-3"><button id="close-add-form-today-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input type="text" id="new-workout-name-today" placeholder="Tên bài tập" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                            <input type="number" id="new-workout-sets-today" placeholder="Số Sets" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-reps-today" placeholder="Số Reps" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-weight-today" placeholder="Tạ (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                            <input type="text" id="new-workout-image-url-today" placeholder="URL hình ảnh (tùy chọn)" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                        </div>
                        <div class="flex space-x-3 mt-3"><button id="add-new-workout-today-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors text-sm">Thêm vào hôm nay</button></div>
                    </div>
                    <div id="workout-list-container" class="p-4 space-y-3"></div>
                </div>`;
            // Gán sự kiện cho các nút
            document.getElementById('add-workout-today-btn').onclick = () => { showAddWorkoutFormToday = true; renderApp(); };
            document.getElementById('save-data-to-sheet-btn').onclick = saveDataToBackendless; 
            if (showAddWorkoutFormToday) {
                document.getElementById('close-add-form-today-btn').onclick = () => { showAddWorkoutFormToday = false; renderApp(); };
                document.getElementById('add-new-workout-today-btn').onclick = addNewWorkoutFromTodayTab;
            }
            renderWorkoutItems(); // Render danh sách các bài tập
            lucide.createIcons(); // Tạo icons
        }

        // Render các mục bài tập trong tab "Hôm nay"
        async function renderWorkoutItems() {
            const workoutListContainer = document.getElementById('workout-list-container');
            if (!workoutListContainer) return;
            workoutListContainer.innerHTML = workouts.length === 0 ? '<p class="text-center text-gray-400 py-4">Chưa có bài tập nào.</p>' : '';

            for (const workout of workouts) {
                const workoutItem = document.createElement('div');
                workoutItem.className = `group flex items-center justify-between p-3 rounded-xl border transition-all duration-200 ${workout.completed ? 'bg-green-500/10 border-green-500/30' : 'bg-gray-800/50 border-gray-700'}`;
                
                // So sánh với lần tập trước
                const currentVolume = (workout.num_sets || 0) * (workout.num_reps || 0); // Có thể thêm * weight nếu muốn so sánh volume có trọng lượng
                const comparisonResult = await getPreviousWorkoutPerformance(workout.master_id, currentVolume);
                let comparisonIcon = '', comparisonColor = 'text-gray-400';
                if (comparisonResult === 'increased') { comparisonIcon = '<i data-lucide="arrow-up" class="w-4 h-4 text-green-400"></i>'; comparisonColor = 'text-green-400'; }
                else if (comparisonResult === 'decreased') { comparisonIcon = '<i data-lucide="arrow-down" class="w-4 h-4 text-red-400"></i>'; comparisonColor = 'text-red-400'; }
                else if (comparisonResult === 'same') { comparisonIcon = '<i data-lucide="minus" class="w-4 h-4 text-blue-400"></i>'; comparisonColor = 'text-blue-400'; }
                else { comparisonIcon = '<i data-lucide="info" class="w-4 h-4 text-gray-400"></i>'; } // 'no_data'

                workoutItem.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1">
                        <button class="toggle-workout-btn transition-colors hover:scale-110 transform flex-shrink-0" data-id="${workout.objectId}">
                            ${workout.completed ? '<i data-lucide="check-circle-2" class="w-5 h-5 text-green-400"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-gray-400 hover:text-green-400"></i>'}
                        </button>
                        <div class="flex items-center space-x-3 flex-1 cursor-pointer workout-details-trigger" data-master-id="${workout.master_id}" data-workout-name="${workout.name}" data-image-url="${workout.image_url || ''}" data-object-id="${workout.objectId}">
                            ${workout.image_url ? `<img src="${workout.image_url}" alt="${workout.name}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/48x48/6b7280/ffffff?text=NoImg';"/>` : `<div class="w-12 h-12 flex items-center justify-center bg-gray-700 rounded-lg flex-shrink-0"><i data-lucide="image" class="w-6 h-6 text-gray-400"></i></div>`}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2">
                                    <h3 class="font-medium text-sm ${workout.completed ? 'text-green-400 line-through' : 'text-white'} truncate">${workout.name}</h3>
                                    <span class="text-xs ${comparisonColor}">${comparisonIcon}</span>
                                </div>
                                <p class="text-gray-400 text-xs mt-1">${workout.num_sets} sets x ${workout.num_reps} reps @ ${workout.weight_kg != null ? workout.weight_kg : '0'}kg</p>
                            </div>
                        </div>
                    </div>
                    <button class="remove-workout-btn opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-all duration-200 ml-2 flex-shrink-0" data-id="${workout.objectId}"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                workoutListContainer.appendChild(workoutItem);
            }
            // Gán sự kiện cho các nút toggle, remove, và mở modal chi tiết
            document.querySelectorAll('.toggle-workout-btn').forEach(b => { b.onclick = (e) => toggleWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('.remove-workout-btn').forEach(b => { b.onclick = (e) => removeWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('#workout-list-container .workout-details-trigger').forEach(el => {
                el.onclick = (e) => showWorkoutDetails(e.currentTarget.dataset.masterId, e.currentTarget.dataset.workoutName, e.currentTarget.dataset.imageUrl, e.currentTarget.dataset.objectId);
            });
            lucide.createIcons();
        }

        // Lấy hiệu suất của bài tập trước đó để so sánh
        async function getPreviousWorkoutPerformance(masterId, currentVolume) {
            if (!masterId) return 'no_data'; // Không có master_id, không có lịch sử để so sánh
            const qb = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}' AND master_id = '${masterId}' AND workout_date < '${getTodayDateString()}'`).setSortBy(['workout_date DESC']).setPageSize(1);
            const data = await Backendless.Data.of('DailyWorkouts').find(qb);
            if (data && data.length > 0) {
                const prevVol = (data[0].num_sets || 0) * (data[0].num_reps || 0); // Có thể thêm * weight nếu muốn
                if (currentVolume > prevVol) return 'increased'; if (currentVolume < prevVol) return 'decreased'; return 'same';
            } return 'no_data'; // Không có dữ liệu trước đó
        }
        
        // Hàm tiện ích để gán lại listener cho một element (tránh listener bị chồng chéo)
        function rebindListeners(elementId, newOnClick) {
            const originalElement = document.getElementById(elementId);
            if (!originalElement) return null;
            const newElement = originalElement.cloneNode(true); // Sao chép element
            originalElement.parentNode.replaceChild(newElement, originalElement); // Thay thế element cũ bằng element mới
            if (newOnClick) {
                newElement.onclick = newOnClick; // Gán listener mới
            }
            return newElement; // Trả về element mới đã được gán listener
        }

        // Hiển thị modal chi tiết bài tập
        async function showWorkoutDetails(masterId, workoutName, imageUrl, currentWorkoutObjectId = null) {
            const modal = document.getElementById('workout-detail-modal');
            const modalWorkoutName = document.getElementById('modal-workout-name');
            const modalWorkoutImageContainer = document.getElementById('modal-workout-image-container');
            
            const modalSetsRepsEditor = document.getElementById('modal-sets-reps-editor');
            const modalSetsInput = document.getElementById('modal-sets-input');
            const modalRepsInput = document.getElementById('modal-reps-input');
            const modalWeightInput = document.getElementById('modal-weight-input');

            const modalWorkoutHistorySection = document.getElementById('modal-workout-history-section');
            const modalWorkoutHistory = document.getElementById('modal-workout-history');

            modalWorkoutName.textContent = workoutName;
            // Xử lý hiển thị hình ảnh hoặc placeholder
            if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined' || imageUrl.trim() === '') {
                modalWorkoutImageContainer.innerHTML = `<div class="w-full h-48 flex items-center justify-center bg-gray-700 rounded-lg"><i data-lucide="image" class="w-24 h-24 text-gray-400"></i></div>`;
            } else {
                modalWorkoutImageContainer.innerHTML = `<img src="${imageUrl}" alt="Workout Image" class="w-full h-48 object-contain rounded-lg" onerror="this.onerror=null;this.parentElement.innerHTML = '<div class=\\'w-full h-48 flex items-center justify-center bg-gray-700 rounded-lg\\'><i data-lucide=\\'image-off\\' class=\\'w-24 h-24 text-gray-400\\'></i></div>'; lucide.createIcons();" />`;
            }
            
            if (currentWorkoutObjectId) { // Nếu mở từ tab "Hôm nay" (có objectId của bài tập hôm nay)
                modalSetsRepsEditor.style.display = 'block'; // Hiển thị form chỉnh sửa
                if (modalWorkoutHistorySection) modalWorkoutHistorySection.style.display = 'none'; // Ẩn lịch sử

                const currentWorkout = workouts.find(w => w.objectId === currentWorkoutObjectId);
                if (currentWorkout) {
                    modalSetsInput.value = currentWorkout.num_sets;
                    modalRepsInput.value = currentWorkout.num_reps;
                    modalWeightInput.value = currentWorkout.weight_kg != null ? currentWorkout.weight_kg : 0;
                } else {
                    // Fallback nếu không tìm thấy workout (ít khi xảy ra)
                    modalSetsInput.value = 1; modalRepsInput.value = 1; modalWeightInput.value = 0;
                    console.warn(`Workout with objectId ${currentWorkoutObjectId} not found for modal editor.`);
                }

                // Gán lại listeners cho các nút +/- và Lưu bằng rebindListeners để tránh lỗi
                rebindListeners('sets-decrement-btn', () => {
                    const cv = parseInt(modalSetsInput.value); modalSetsInput.value = Math.max(1, (isNaN(cv) ? 2 : cv) - 1);
                });
                rebindListeners('sets-increment-btn', () => {
                    const cv = parseInt(modalSetsInput.value); modalSetsInput.value = (isNaN(cv) ? 0 : cv) + 1;
                });
                rebindListeners('reps-decrement-btn', () => {
                    const cv = parseInt(modalRepsInput.value); modalRepsInput.value = Math.max(1, (isNaN(cv) ? 2 : cv) - 1);
                });
                rebindListeners('reps-increment-btn', () => {
                    const cv = parseInt(modalRepsInput.value); modalRepsInput.value = (isNaN(cv) ? 0 : cv) + 1;
                });
                rebindListeners('weight-decrement-btn', () => {
                    const cv = parseFloat(modalWeightInput.value); 
                    let newVal = (isNaN(cv) ? MODAL_WEIGHT_ADJUST_STEP : cv) - MODAL_WEIGHT_ADJUST_STEP;
                    modalWeightInput.value = Math.max(0, newVal).toFixed(2);
                });
                rebindListeners('weight-increment-btn', () => {
                    const cv = parseFloat(modalWeightInput.value); 
                    let newVal = (isNaN(cv) ? -MODAL_WEIGHT_ADJUST_STEP : cv) + MODAL_WEIGHT_ADJUST_STEP;
                    modalWeightInput.value = newVal.toFixed(2);
                });
                rebindListeners('save-workout-details-btn', () => {
                    const newSets = parseInt(modalSetsInput.value); 
                    const newReps = parseInt(modalRepsInput.value);
                    const newWeight = parseFloat(modalWeightInput.value);

                    if (!isNaN(newSets) && !isNaN(newReps) && !isNaN(newWeight) && newSets > 0 && newReps > 0 && newWeight >= 0) {
                        updateWorkoutDetails(currentWorkoutObjectId, newSets, newReps, newWeight);
                    } else { showMessage("Sets, Reps phải là số dương và Tạ phải là số không âm!", "error"); }
                });

            } else { // Nếu mở từ tab "Bài tập của tôi" (chỉ có masterId, không có objectId của bài tập hôm nay)
                modalSetsRepsEditor.style.display = 'none'; // Ẩn form chỉnh sửa
                if (modalWorkoutHistorySection) modalWorkoutHistorySection.style.display = 'block'; // Hiển thị lịch sử
                if (!masterId) {
                     modalWorkoutHistory.innerHTML = '<p class="text-center text-gray-400">Không có master ID để tải lịch sử.</p>';
                } else {
                    // Tải và hiển thị lịch sử 5 lần tập gần nhất của bài tập này
                    const queryBuilder = Backendless.DataQueryBuilder.create().setWhereClause(`ownerId = '${userId}' AND master_id = '${masterId}'`).setSortBy(['workout_date DESC']).setPageSize(5);
                    try {
                        const historyData = await Backendless.Data.of('DailyWorkouts').find(queryBuilder);
                        modalWorkoutHistory.innerHTML = ''; // Xóa lịch sử cũ
                        if (historyData && historyData.length > 0) {
                            historyData.forEach(entry => { 
                                const item = document.createElement('div'); item.className = 'flex justify-between items-center bg-gray-800/50 p-3 rounded-lg';
                                item.innerHTML = `<span class="text-sm font-medium">${formatDate(entry.workout_date)}</span><span class="text-sm text-gray-300">${entry.num_sets}x${entry.num_reps} @ ${entry.weight_kg != null ? entry.weight_kg : '0'}kg</span>`;
                                modalWorkoutHistory.appendChild(item);
                            });
                        } else { modalWorkoutHistory.innerHTML = '<p class="text-center text-gray-400">Chưa có lịch sử.</p>'; }
                    } catch (error) {
                        console.error("Lỗi tải lịch sử bài tập:", error);
                        modalWorkoutHistory.innerHTML = '<p class="text-center text-red-400">Lỗi tải lịch sử.</p>';
                    }
                }
            }
            modal.classList.add('open'); // Mở modal
            lucide.createIcons(); // Tạo icons
        }

        // Đóng modal chi tiết bài tập
        function closeWorkoutDetailsModal() { document.getElementById('workout-detail-modal').classList.remove('open'); }

        // Cập nhật chi tiết bài tập (Sets, Reps, Tạ)
        async function updateWorkoutDetails(objectId, newSets, newReps, newWeight) {
            const workoutIndex = workouts.findIndex(w => w.objectId === objectId);
            if (workoutIndex > -1) {
                const updatedWorkoutData = { 
                    objectId: objectId, 
                    num_sets: newSets, 
                    num_reps: newReps, 
                    weight_kg: newWeight,
                    volume: newSets * newReps // Cập nhật volume nếu cần
                };
                try {
                    await Backendless.Data.of('DailyWorkouts').save(updatedWorkoutData); // Lưu vào Backendless
                    // Cập nhật lại trong mảng workouts cục bộ
                    workouts[workoutIndex].num_sets = newSets; 
                    workouts[workoutIndex].num_reps = newReps; 
                    workouts[workoutIndex].weight_kg = newWeight;
                    workouts[workoutIndex].volume = newSets * newReps;
                    updateCurrentDayWeeklyStat(); // Cập nhật thống kê ngày
                    showMessage("Đã cập nhật chi tiết bài tập!", "success");
                    closeWorkoutDetailsModal(); // Đóng modal
                    renderApp(); // Render lại giao diện
                } catch (error) { console.error("Lỗi cập nhật chi tiết bài tập:", error); showMessage("Lỗi cập nhật chi tiết bài tập.", "error"); }
            }
        }

        // Render nội dung tab "Bài tập của tôi"
        function renderMyWorkoutsTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="bg-black/30 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden mb-6">
                    <div class="p-4 border-b border-white/10"><div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold">Tất cả bài tập của tôi</h2>
                        <button id="add-workout-my-workouts-btn" class="flex items-center space-x-1 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-3 py-2 rounded-lg transition-all duration-200 text-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i><span class="hidden sm:inline">Thêm bài tập mới</span>
                        </button></div></div>
                    <div id="add-new-workout-form-my-workouts" class="p-4 bg-gray-800/50 border-b border-white/10" style="display: ${showAddWorkoutFormMyWorkouts ? 'block' : 'none'};">
                        <div class="flex justify-end mb-3"><button id="close-add-form-my-workouts-btn" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <input type="text" id="new-workout-name-my-workouts" placeholder="Tên bài tập" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                            <input type="number" id="new-workout-sets-my-workouts" placeholder="Số Sets" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-reps-my-workouts" placeholder="Số Reps" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="1" />
                            <input type="number" id="new-workout-default-weight-my-workouts" placeholder="Tạ mặc định (kg)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" min="0" step="0.25" />
                            <input type="text" id="new-workout-image-url-my-workouts" placeholder="URL hình ảnh (tùy chọn)" class="sm:col-span-3 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" />
                        </div>
                        <div class="flex space-x-3 mt-3"><button id="add-new-workout-my-workouts-btn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors text-sm">Thêm vào danh sách chính</button></div>
                    </div>
                    <div id="all-workouts-list-container" class="p-4 space-y-3"></div>
                </div>`;
            // Gán sự kiện cho các nút
            document.getElementById('add-workout-my-workouts-btn').onclick = () => { showAddWorkoutFormMyWorkouts = true; renderApp(); };
            if (showAddWorkoutFormMyWorkouts) {
                document.getElementById('close-add-form-my-workouts-btn').onclick = () => { showAddWorkoutFormMyWorkouts = false; renderApp(); };
                document.getElementById('add-new-workout-my-workouts-btn').onclick = addNewWorkoutFromMyWorkoutsTab;
            }
            renderAllWorkoutItems(); // Render danh sách tất cả bài tập
            lucide.createIcons();
        }

        // Render danh sách tất cả bài tập (master list)
        function renderAllWorkoutItems() {
            const cont = document.getElementById('all-workouts-list-container'); if (!cont) return;
            cont.innerHTML = allWorkouts.length === 0 ? '<p class="text-center text-gray-400 py-4">Chưa có bài tập nào.</p>' : '';
            allWorkouts.sort((a,b) => (a.name || "").localeCompare(b.name || "")).forEach(w => { // Sắp xếp theo tên
                const item = document.createElement('div'); item.className = `flex items-center justify-between p-3 rounded-xl border bg-gray-800/50 border-gray-700`;
                item.innerHTML = `
                    <div class="flex items-center space-x-3 flex-1 cursor-pointer workout-details-trigger" data-master-id="${w.objectId}" data-workout-name="${w.name}" data-image-url="${w.image_url || ''}">
                        ${w.image_url ? `<img src="${w.image_url}" alt="${w.name}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/48x48/6b7280/ffffff?text=NoImg';"/>` : `<div class="w-12 h-12 flex items-center justify-center bg-gray-700 rounded-lg flex-shrink-0"><i data-lucide="image" class="w-6 h-6 text-gray-400"></i></div>`}
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-sm text-white truncate">${w.name}</h3>
                            <p class="text-gray-400 text-xs mt-1">${w.num_sets}x${w.num_reps} @ ${w.default_weight_kg != null ? w.default_weight_kg : '0'}kg (mặc định)</p>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-2 flex-shrink-0">
                        <button class="add-to-today-btn bg-green-500 hover:bg-green-600 p-2 rounded-lg text-xs transition-colors" data-id="${w.objectId}"><i data-lucide="calendar-plus" class="w-4 h-4"></i></button>
                        <button class="remove-master-workout-btn text-red-400 hover:text-red-300 transition-all duration-200" data-id="${w.objectId}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                cont.appendChild(item);
            });
            // Gán sự kiện cho các nút
            document.querySelectorAll('.add-to-today-btn').forEach(b => { b.onclick = (e) => addSelectedWorkoutToToday(e.currentTarget.dataset.id); });
            document.querySelectorAll('.remove-master-workout-btn').forEach(b => { b.onclick = (e) => removeMasterWorkout(e.currentTarget.dataset.id); });
            document.querySelectorAll('#all-workouts-list-container .workout-details-trigger').forEach(el => {
                // Khi click vào bài tập, hiển thị modal chi tiết (chỉ lịch sử, không chỉnh sửa)
                el.onclick = (e) => showWorkoutDetails(e.currentTarget.dataset.masterId, e.currentTarget.dataset.workoutName, e.currentTarget.dataset.imageUrl, null);
            });
            lucide.createIcons();
        }

        // Render nội dung tab "Thống kê"
        function renderStatsTab() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 backdrop-blur-lg rounded-xl p-4 border border-purple-500/30 text-center">
                            <i data-lucide="activity" class="w-8 h-8 text-purple-400 mx-auto mb-2"></i><p class="text-2xl font-bold">${getCurrentWeekTotalCompleted()}</p><p class="text-xs text-purple-300">Bài tập (7 ngày)</p></div>
                        <div class="bg-gradient-to-br from-green-500/20 to-blue-500/20 backdrop-blur-lg rounded-xl p-4 border border-green-500/30 text-center">
                            <i data-lucide="award" class="w-8 h-8 text-green-400 mx-auto mb-2"></i><p class="text-2xl font-bold">${getWeeklyAverage()}%</p><p class="text-xs text-green-300">TB hoàn thành (7 ngày)</p></div>
                    </div>
                    <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 border border-white/10">
                        <h3 class="text-lg font-bold mb-4 flex items-center"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-purple-400"></i>Lịch sử hoạt động</h3>
                        <div id="weekly-stats-container" class="space-y-3"></div></div>
                    <div class="bg-black/30 backdrop-blur-lg rounded-2xl p-4 border border-white/10">
                        <h3 class="text-lg font-bold mb-4 flex items-center"><i data-lucide="trophy" class="w-5 h-5 mr-2 text-yellow-400"></i>Thành tích</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-orange-500/20 rounded-lg"><i data-lucide="flame" class="w-5 h-5 text-orange-400"></i></div><div><p class="font-medium">Chuỗi ngày liên tiếp</p><p class="text-sm text-gray-400">Tập luyện đều đặn</p></div></div><span class="text-xl font-bold text-orange-400">${streak} ngày</span></div>
                            <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-green-500/20 rounded-lg"><i data-lucide="calendar" class="w-5 h-5 text-green-400"></i></div><div><p class="font-medium">Ngày tích cực nhất</p><p class="text-sm text-gray-400">Hoàn thành nhiều nhất</p></div></div><span class="text-sm font-bold text-green-400">${getMostActiveDay()}</span></div>
                            <div class="flex items-center justify-between p-3 bg-blue-500/20 rounded-lg"><div class="flex items-center space-x-3"><div class="p-2 bg-blue-500/20 rounded-lg"><i data-lucide="trending-up" class="w-5 h-5 text-blue-400"></i></div><div><p class="font-medium">Tổng bài tập</p><p class="text-sm text-gray-400">Từ khi bắt đầu</p></div></div><span class="text-xl font-bold text-blue-400">${totalWorkouts}</span></div>
                        </div></div></div>`;
            renderWeeklyStatsHistory(); // Render lịch sử thống kê tuần
            lucide.createIcons();
        }

        // Render lịch sử thống kê tuần
        function renderWeeklyStatsHistory() {
            const cont = document.getElementById('weekly-stats-container'); if (!cont) return;
            cont.innerHTML = weeklyStats.length === 0 ? '<p class="text-center text-gray-400 py-4">Chưa có dữ liệu thống kê.</p>' : '';
            weeklyStats.forEach(day => {
                const perc = day.total > 0 ? (day.completed / day.total) * 100 : 0;
                const isToday = day.date === getTodayDateString();
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg ${isToday && day.date === currentDayString ? 'bg-purple-500/20 border border-purple-500/30' : 'bg-gray-800/50'}`; // Highlight ngày hiện tại
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2"><span class="text-sm font-medium">${formatDate(day.date)}${isToday && day.date === currentDayString ? '<span class="text-purple-400 ml-1">(Hôm nay)</span>' : ''}</span></div>
                        <span class="text-sm text-gray-400">${day.completed}/${day.total}</span></div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-1"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${perc}%"></div></div>
                    ${day.exercises && day.exercises.length > 0 ? `<div class="flex flex-wrap gap-1 mt-2">${day.exercises.slice(0,3).map(ex => `<span class="px-2 py-0.5 bg-gray-700/80 rounded text-xs whitespace-nowrap">${ex}</span>`).join('')}${day.exercises.length > 3 ? `<span class="px-2 py-0.5 bg-gray-700/80 rounded text-xs">+${day.exercises.length - 3}</span>` : ''}</div>` : '<p class="text-xs text-gray-500 italic mt-1">Không có bài tập.</p>'}`;
                cont.appendChild(item);
            });
            lucide.createIcons();
        }

        // Render toàn bộ ứng dụng (header và tab hiện tại)
        function renderApp() {
            document.getElementById('loading-overlay').style.display = isLoading ? 'flex' : 'none';
            renderHeader();
            if (currentTab === 'today') renderTodayTab();
            else if (currentTab === 'my-workouts') renderMyWorkoutsTab();
            else renderStatsTab();
            lucide.createIcons(); // Đảm bảo icons được render sau mỗi lần cập nhật DOM
        }

        // Chuyển đổi trạng thái hoàn thành của bài tập
        async function toggleWorkout(objectId) {
            const idx = workouts.findIndex(w => w.objectId === objectId);
            if (idx > -1) {
                const newStatus = !workouts[idx].completed; 
                try { 
                    await Backendless.Data.of('DailyWorkouts').save({ objectId: objectId, completed: newStatus }); // Lưu vào Backendless
                    workouts[idx].completed = newStatus; // Cập nhật cục bộ
                    updateCurrentDayWeeklyStat(); // Cập nhật thống kê
                    renderApp(); // Render lại
                }
                catch (e) { 
                    console.error("Lỗi toggle workout:", e); 
                    showMessage("Lỗi cập nhật trạng thái bài tập.", "error"); 
                }
            }
        }

        // Thêm bài tập mới từ tab "Hôm nay"
        async function addNewWorkoutFromTodayTab() {
            const name = document.getElementById('new-workout-name-today').value.trim();
            const setsStr = document.getElementById('new-workout-sets-today').value.trim();
            const repsStr = document.getElementById('new-workout-reps-today').value.trim();
            const weightStr = document.getElementById('new-workout-weight-today').value.trim();
            const img = document.getElementById('new-workout-image-url-today').value.trim();

            const sets = parseInt(setsStr);
            const reps = parseInt(repsStr);
            let weight = parseFloat(weightStr);
            if (isNaN(weight) || weight < 0) weight = 0; // Mặc định tạ là 0 nếu không hợp lệ

            if (!name || isNaN(sets) || isNaN(reps) || sets <= 0 || reps <= 0) { 
                showMessage("Tên, Sets, Reps không hợp lệ!", "error"); return; 
            }
            
            let masterId;
            // Kiểm tra xem bài tập này đã có trong danh sách chính (AllWorkouts) chưa (dựa trên tên)
            let existingMaster = allWorkouts.find(w => w.name === name); // So khớp đơn giản bằng tên
            
            if (existingMaster) {
                masterId = existingMaster.objectId; // Sử dụng masterId hiện có
            } else {
                // Nếu chưa có, tạo mới trong AllWorkouts
                try { 
                    const masterPayload = { name, num_sets: sets, num_reps: reps, default_weight_kg: weight, image_url: img };
                    // if(userId) masterPayload.ownerId = userId; // Nếu AllWorkouts là của riêng người dùng
                    const savedMaster = await Backendless.Data.of('AllWorkouts').save(masterPayload); 
                    masterId = savedMaster.objectId; 
                    allWorkouts.push(savedMaster); // Thêm vào danh sách cục bộ
                }
                catch(e) { console.error("Lỗi thêm master workout:", e); showMessage("Lỗi thêm bài tập chính.", "error"); return; }
            }

            // Tạo bản ghi cho DailyWorkouts
            const dailyPayload = { 
                master_id: masterId, 
                ownerId: userId, 
                name, 
                num_sets: sets, 
                num_reps: reps, 
                weight_kg: weight,
                volume: sets * reps, // Tính volume
                image_url: img || (existingMaster ? existingMaster.image_url : ''), // Ưu tiên ảnh mới, nếu không có thì lấy ảnh từ master
                completed: false, 
                workout_date: getTodayDateString() 
            };

            try {
                const newDaily = await Backendless.Data.of('DailyWorkouts').save(dailyPayload); 
                workouts.push(newDaily); 
                totalWorkouts++; 
                updateCurrentDayWeeklyStat(); 
                showMessage("Đã thêm bài tập cho hôm nay!", "success");
                // Xóa các trường input
                ['new-workout-name-today', 'new-workout-sets-today', 'new-workout-reps-today', 'new-workout-weight-today', 'new-workout-image-url-today'].forEach(id => document.getElementById(id).value = '');
                showAddWorkoutFormToday = false; // Ẩn form
                renderApp();
            } catch (e) { console.error("Lỗi thêm daily workout:", e); showMessage("Lỗi thêm bài tập hôm nay.", "error"); }
        }

        // Thêm bài tập mới từ tab "Bài tập của tôi" (thêm vào danh sách chính AllWorkouts)
        async function addNewWorkoutFromMyWorkoutsTab() {
            const name = document.getElementById('new-workout-name-my-workouts').value.trim();
            const setsStr = document.getElementById('new-workout-sets-my-workouts').value.trim();
            const repsStr = document.getElementById('new-workout-reps-my-workouts').value.trim();
            const defaultWeightStr = document.getElementById('new-workout-default-weight-my-workouts').value.trim();
            const img = document.getElementById('new-workout-image-url-my-workouts').value.trim();

            const sets = parseInt(setsStr);
            const reps = parseInt(repsStr);
            let defaultWeight = parseFloat(defaultWeightStr);
            if (isNaN(defaultWeight) || defaultWeight < 0) defaultWeight = 0;

            if (!name || isNaN(sets) || isNaN(reps) || sets <= 0 || reps <= 0) { 
                showMessage("Tên, Sets, Reps không hợp lệ!", "error"); return; 
            }
            // Kiểm tra trùng lặp trong danh sách chính
            if (allWorkouts.some(w => w.name === name && w.num_sets === sets && w.num_reps === reps && (w.default_weight_kg || 0) === defaultWeight)) { 
                showMessage("Bài tập này đã tồn tại trong danh sách chính!", "info"); return; 
            }
            try {
                const masterPayload = { name, num_sets: sets, num_reps: reps, default_weight_kg: defaultWeight, image_url: img };
                // if(userId) masterPayload.ownerId = userId; // Nếu AllWorkouts là của riêng người dùng
                const saved = await Backendless.Data.of('AllWorkouts').save(masterPayload); 
                allWorkouts.push(saved);
                allWorkouts.sort((a,b) => (a.name || "").localeCompare(b.name || "")); // Sắp xếp lại
                showMessage("Đã thêm vào danh sách chính!", "success");
                // Xóa các trường input
                ['new-workout-name-my-workouts', 'new-workout-sets-my-workouts', 'new-workout-reps-my-workouts', 'new-workout-default-weight-my-workouts', 'new-workout-image-url-my-workouts'].forEach(id => document.getElementById(id).value = '');
                showAddWorkoutFormMyWorkouts = false; // Ẩn form
                renderApp();
            } catch (e) { console.error("Lỗi thêm master workout:", e); showMessage("Lỗi thêm bài tập vào danh sách chính.", "error"); }
        }

        // Thêm bài tập đã chọn từ danh sách chính vào danh sách hôm nay
        async function addSelectedWorkoutToToday(masterWorkoutObjectId) {
            const workoutToAdd = allWorkouts.find(w => w.objectId === masterWorkoutObjectId);
            if (workoutToAdd) {
                // Kiểm tra xem bài tập này (dựa trên master_id) đã có trong danh sách hôm nay chưa
                if (!workouts.some(w => w.master_id === masterWorkoutObjectId && w.workout_date === getTodayDateString())) {
                    const dailyPayload = { 
                        master_id: masterWorkoutObjectId, 
                        ownerId: userId, 
                        name: workoutToAdd.name, 
                        num_sets: workoutToAdd.num_sets, 
                        num_reps: workoutToAdd.num_reps, 
                        weight_kg: workoutToAdd.default_weight_kg != null ? workoutToAdd.default_weight_kg : 0, // Lấy tạ mặc định
                        volume: (workoutToAdd.num_sets || 0) * (workoutToAdd.num_reps || 0), 
                        image_url: workoutToAdd.image_url || '', 
                        completed: false, 
                        workout_date: getTodayDateString() 
                    };
                    try { 
                        const newDaily = await Backendless.Data.of('DailyWorkouts').save(dailyPayload); 
                        workouts.push(newDaily); 
                        totalWorkouts++; 
                        updateCurrentDayWeeklyStat(); 
                        showMessage("Đã thêm vào bài tập hôm nay!", "success"); 
                        renderApp(); 
                    }
                    catch (e) { console.error("Lỗi thêm selected workout to today:", e); showMessage("Lỗi thêm bài tập vào hôm nay.", "error"); }
                } else showMessage("Bài tập này đã có trong danh sách hôm nay!", "info");
            }
        }

        // Xóa bài tập khỏi danh sách hôm nay
        async function removeWorkout(objectId) { 
            try { 
                await Backendless.Data.of('DailyWorkouts').remove({ objectId }); 
                workouts = workouts.filter(w => w.objectId !== objectId); 
                updateCurrentDayWeeklyStat(); 
                showMessage("Đã xóa bài tập khỏi hôm nay.", "success"); 
                renderApp(); 
            }
            catch (e) { console.error("Lỗi xóa daily workout:", e); showMessage("Lỗi xóa bài tập.", "error"); }
        }
        // Xóa bài tập khỏi danh sách chính (AllWorkouts)
        async function removeMasterWorkout(objectId) { 
            // Sử dụng một hộp thoại xác nhận tùy chỉnh thay vì window.confirm
            // Ví dụ: hiển thị một modal xác nhận
            // Hiện tại, để đơn giản, bỏ qua bước xác nhận hoặc bạn có thể tự thêm
            // if (!confirm("Bạn có chắc chắn muốn xóa bài tập này khỏi danh sách chính?")) {
            //     return;
            // }
            // Thay vì confirm, bạn có thể hiển thị một modal tùy chỉnh ở đây
            // và chỉ thực hiện xóa nếu người dùng xác nhận trong modal đó.
            // Ví dụ:
            // showCustomConfirm("Bạn có chắc chắn muốn xóa bài tập này khỏi danh sách chính?", async () => {
            //    // logic xóa ở đây
            // });
            // return; // Chờ xác nhận từ modal
            
            // Tạm thời vẫn dùng cách cũ, nhưng khuyến khích dùng modal tùy chỉnh
             if (!confirm("Bạn có chắc chắn muốn xóa bài tập này khỏi danh sách chính? Thao tác này cũng sẽ xóa bài tập này khỏi lịch sử tập luyện của bạn (nếu có).")) {
                 return;
             }


            try { 
                await Backendless.Data.of('AllWorkouts').remove({ objectId }); 
                allWorkouts = allWorkouts.filter(w => w.objectId !== objectId); 
                // Tùy chọn: Xóa bài tập này khỏi danh sách hôm nay nếu có
                const wasInToday = workouts.some(w => w.master_id === objectId);
                workouts = workouts.filter(w => w.master_id !== objectId);
                if (wasInToday) updateCurrentDayWeeklyStat();

                // Tùy chọn: Xóa khỏi lịch sử (DailyWorkouts) của tất cả các ngày
                // const relatedDailyQuery = Backendless.DataQueryBuilder.create().setWhereClause(`master_id = '${objectId}' AND ownerId = '${userId}'`);
                // await Backendless.Data.of('DailyWorkouts').bulkDelete(relatedDailyQuery);
                // Cần tải lại weeklyStats nếu muốn nó phản ánh việc xóa khỏi lịch sử

                showMessage("Đã xóa bài tập khỏi danh sách chính.", "success"); 
                renderApp(); 
            }
            catch (e) { console.error("Lỗi xóa master workout:", e); showMessage("Lỗi xóa bài tập khỏi danh sách chính.", "error"); }
        }

        // Xử lý đăng ký
        async function handleSignUp() {
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-password').value;
            if (!email || !pass) { showMessage("Vui lòng nhập email và mật khẩu.", "error"); return; }
            const user = new Backendless.User(); user.email = email; user.password = pass;
            try { 
                await Backendless.UserService.register(user); 
                showMessage("Đăng ký thành công! Vui lòng kiểm tra email để xác thực (nếu được cấu hình). Sau đó đăng nhập.", "success"); 
            }
            catch (e) { showMessage(`Đăng ký thất bại: ${e.message}`, "error"); console.error("Lỗi Đăng ký:", e); }
        }
        // Xử lý đăng nhập
        async function handleSignIn() {
            const email = document.getElementById('auth-email').value, pass = document.getElementById('auth-password').value;
            if (!email || !pass) { showMessage("Vui lòng nhập email và mật khẩu.", "error"); return; }
            try { 
                const user = await Backendless.UserService.login(email, pass, true); // true để ghi nhớ đăng nhập
                userId = user.objectId;
                showMessage("Đăng nhập thành công!", "success");
                document.getElementById('auth-container').style.display = 'none'; 
                document.getElementById('app-container').style.display = 'block';
                currentDayString = getTodayDateString(); // Đặt lại ngày hiện tại sau khi đăng nhập
                await loadDataFromBackendless(); // Tải dữ liệu cho người dùng mới
                initializeAppAndHandleDailyRollover(); // Xử lý chuyển ngày
                renderApp();
            } catch (e) { showMessage(`Đăng nhập thất bại: ${e.message}`, "error"); console.error("Lỗi Đăng nhập:", e); }
        }

        // Sự kiện khi DOM đã tải xong
        document.addEventListener('DOMContentLoaded', async () => {
            updateLiveDateTime(); setInterval(updateLiveDateTime, 1000 * 30); // Cập nhật đồng hồ mỗi 30 giây
            try {
                isLoading = true; 
                document.getElementById('loading-overlay').style.display = 'flex';
                lucide.createIcons(); // Tạo icons ban đầu

                const currentUser = await Backendless.UserService.getCurrentUser(); // Kiểm tra xem người dùng đã đăng nhập chưa
                if (currentUser) {
                    userId = currentUser.objectId;
                    document.getElementById('auth-container').style.display = 'none'; // Ẩn form đăng nhập/đăng ký
                    document.getElementById('app-container').style.display = 'block'; // Hiển thị ứng dụng
                    currentDayString = getTodayDateString(); 
                    await loadDataFromBackendless(); 
                    initializeAppAndHandleDailyRollover(); 
                    renderApp();
                } else {
                    // Người dùng chưa đăng nhập
                    userId = null; 
                    document.getElementById('auth-container').style.display = 'flex'; // Hiển thị form đăng nhập/đăng ký
                    document.getElementById('app-container').style.display = 'none'; // Ẩn ứng dụng
                    isLoading = false; 
                    document.getElementById('loading-overlay').style.display = 'none'; // Ẩn loading
                    lucide.createIcons(); // Tạo icons cho form đăng nhập
                }
            } catch (e) {
                // Xử lý lỗi nếu không kiểm tra được người dùng hiện tại (ví dụ: mất kết nối)
                console.error("Lỗi kiểm tra đăng nhập:", e); 
                userId = null;
                document.getElementById('auth-container').style.display = 'flex'; 
                document.getElementById('app-container').style.display = 'none';
                isLoading = false; 
                document.getElementById('loading-overlay').style.display = 'none'; 
                lucide.createIcons();
            } finally {
                // Đảm bảo overlay loading luôn được ẩn nếu không còn loading
                if (!isLoading && document.getElementById('loading-overlay').style.display !== 'none') {
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            }

            // Gán sự kiện cho các nút đăng ký, đăng nhập
            document.getElementById('signup-btn').addEventListener('click', handleSignUp);
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);
            
            // Gán sự kiện cho các nút tab
            ['today', 'my-workouts', 'stats'].forEach(tab => {
                const btn = document.getElementById(`${tab}-tab-btn`);
                if(btn) btn.addEventListener('click', () => {
                    currentTab = tab; 
                    showAddWorkoutFormToday = false; // Reset trạng thái form khi chuyển tab
                    showAddWorkoutFormMyWorkouts = false; 
                    renderApp();
                });
            });

            // Gán sự kiện cho nút đóng modal
            const closeModalButton = document.getElementById('close-workout-detail-modal');
            if(closeModalButton) closeModalButton.addEventListener('click', closeWorkoutDetailsModal);
            
            // Gán sự kiện đóng modal khi click ra ngoài (vào overlay)
            const modalOverlay = document.getElementById('workout-detail-modal');
            if(modalOverlay) modalOverlay.addEventListener('click', (e) => { 
                if (e.target === e.currentTarget) closeWorkoutDetailsModal(); // Chỉ đóng nếu click trực tiếp vào overlay
            });
            
            // Nếu cả app và auth đều ẩn (trường hợp hiếm), vẫn tạo icons
            if(document.getElementById('app-container').style.display === 'none' && document.getElementById('auth-container').style.display === 'none'){
                 lucide.createIcons();
            }
        });
        // Tạo lại icons khi thay đổi kích thước cửa sổ (để đảm bảo hiển thị đúng)
        window.addEventListener('resize', () => { lucide.createIcons(); }); 
    </script>
</body>
</html>
